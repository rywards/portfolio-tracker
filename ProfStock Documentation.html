<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 11.2.0"/>
    <title>app API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{filter:opacity(1);}.pdoc details:not([open]){height:0;}.pdoc details > summary{position:absolute;top:-35px;right:0;font-size:.75rem;color:var(--muted);padding:0 .7em;user-select:none;cursor:pointer;}.pdoc details > summary:focus{outline:0;}.pdoc > section.module-info details > summary{top:-20px;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;user-select:none;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{display:block;color:var(--text);margin:.5rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>




        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="function" href="#session_info">session_info</a>
            </li>
            <li>
                    <a class="function" href="#stock_init_val">stock_init_val</a>
            </li>
            <li>
                    <a class="function" href="#stock_curr_val">stock_curr_val</a>
            </li>
            <li>
                    <a class="function" href="#stockAPI">stockAPI</a>
            </li>
            <li>
                    <a class="function" href="#users">users</a>
            </li>
            <li>
                    <a class="function" href="#login">login</a>
            </li>
            <li>
                    <a class="function" href="#callback">callback</a>
            </li>
            <li>
                    <a class="function" href="#logout">logout</a>
            </li>
            <li>
                    <a class="function" href="#leaderboard">leaderboard</a>
            </li>
            <li>
                    <a class="function" href="#home">home</a>
            </li>
            <li>
                    <a class="function" href="#profile">profile</a>
            </li>
            <li>
                    <a class="function" href="#pullstockinfo">pullstockinfo</a>
            </li>
            <li>
                    <a class="function" href="#portfolio">portfolio</a>
            </li>
            <li>
                    <a class="function" href="#watchlist">watchlist</a>
            </li>
            <li>
                    <a class="function" href="#snapshot">snapshot</a>
            </li>
            <li>
                    <a class="function" href="#page_not_found">page_not_found</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
app    </h1>

                
                        <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="L-0"><a href="#L-0"><span class="linenos">  0</span></a><span class="kn">from</span> <span class="nn">importlib.metadata</span> <span class="kn">import</span> <span class="n">metadata</span>
</span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">requests</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">indent</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">import</span> <span class="nn">time</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">send_file</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">environ</span> <span class="k">as</span> <span class="n">env</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote_plus</span><span class="p">,</span> <span class="n">urlencode</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">response</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">from</span> <span class="nn">authlib.integrations.flask_client</span> <span class="kn">import</span> <span class="n">OAuth</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">find_dotenv</span><span class="p">,</span> <span class="n">load_dotenv</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">insert</span><span class="p">,</span><span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">select</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Session</span> <span class="k">as</span> <span class="n">Alcsession</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">func</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="c1"># initializing database connection and sqlalchemy session</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;mysql+mysqldb://root:root@localhost/profstock&quot;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">future</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="n">alcsession</span> <span class="o">=</span> <span class="n">Alcsession</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="n">metadata_obj</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="c1"># Loading env file for Auth0 and </span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="c1"># initializing flask app</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="n">ENV_FILE</span> <span class="o">=</span> <span class="n">find_dotenv</span><span class="p">()</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="k">if</span> <span class="n">ENV_FILE</span><span class="p">:</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>    <span class="n">load_dotenv</span><span class="p">(</span><span class="n">ENV_FILE</span><span class="p">)</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;APP_SECRET_KEY&quot;</span><span class="p">)</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="n">oauth</span> <span class="o">=</span> <span class="n">OAuth</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="n">oauth</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>    <span class="s2">&quot;auth0&quot;</span><span class="p">,</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>    <span class="n">client_id</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AUTH0_CLIENT_ID&quot;</span><span class="p">),</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>    <span class="n">client_secret</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AUTH0_CLIENT_SECRET&quot;</span><span class="p">),</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>    <span class="n">client_kwargs</span><span class="o">=</span><span class="p">{</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>        <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot;openid profile email&quot;</span><span class="p">,</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>    <span class="p">},</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>    <span class="n">server_metadata_url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;https://</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AUTH0_DOMAIN&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">/.well-known/openid-configuration&#39;</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="p">)</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="k">def</span> <span class="nf">session_info</span><span class="p">():</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>    <span class="sd">&#39;&#39;&#39; </span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">    Function returns current user&#39;s session information in JSON format. </span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>    <span class="n">sessioninfo</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>    <span class="n">pretty</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sessioninfo</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>    <span class="n">userinfo</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pretty</span><span class="p">)</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>    <span class="k">return</span> <span class="n">userinfo</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="k">def</span> <span class="nf">stock_init_val</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">buydate</span><span class="p">):</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>    <span class="sd">&#39;&#39;&#39; </span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">    Function to get the initial purchase amount of a stock</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">    based on the buydate.</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd">    Takes in a ticker, amount, and the buydate of the stock</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">    -----------------------------------------------------------</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">    NOTE: 5 year history limit. Buydate cannot be more than 5 years </span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">    from the current day. </span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>    <span class="c1"># getting the most recent stock data</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>    <span class="s1">&#39;access_key&#39;</span><span class="p">:</span> <span class="s1">&#39;b690ef1a94c38681861a3a78272a9c98&#39;</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>    <span class="p">}</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>    <span class="n">route</span> <span class="o">=</span> <span class="s1">&#39;http://api.marketstack.com/v1/tickers/&#39;</span> <span class="o">+</span> <span class="n">ticker</span> <span class="o">+</span> <span class="s1">&#39;/eod/&#39;</span> <span class="o">+</span> <span class="n">buydate</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>    <span class="n">api_buydate</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>    <span class="n">buydate_info</span> <span class="o">=</span> <span class="n">api_buydate</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">buydate_info</span><span class="p">)</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>    <span class="n">buydate_value</span> <span class="o">=</span> <span class="n">buydate_info</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">amount</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>    <span class="k">return</span> <span class="n">buydate_value</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="k">def</span> <span class="nf">stock_curr_val</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">    Function to get the current value of a portfolio holding</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="sd">    Takes in a ticker and amount to calculate the current </span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="sd">    value.</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">    Returns the current value of the stock </span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>    <span class="c1"># getting the most recent stock data</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>    <span class="s1">&#39;access_key&#39;</span><span class="p">:</span> <span class="s1">&#39;b690ef1a94c38681861a3a78272a9c98&#39;</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>    <span class="p">}</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>    <span class="n">route</span> <span class="o">=</span> <span class="s1">&#39;http://api.marketstack.com/v1/tickers/&#39;</span> <span class="o">+</span> <span class="n">ticker</span> <span class="o">+</span> <span class="s1">&#39;/eod/latest&#39;</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>    <span class="n">api_current</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>    <span class="n">curr_info</span> <span class="o">=</span> <span class="n">api_current</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>    <span class="n">curr_val</span> <span class="o">=</span> <span class="n">curr_info</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">amount</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>    <span class="k">return</span> <span class="n">curr_val</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="k">def</span> <span class="nf">stockAPI</span><span class="p">(</span><span class="n">ticker</span><span class="p">):</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">    Function calls marketstack API for ticker information</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">    Takes in ticker and returns stock info in JSON format</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="sd">    API link: https://marketstack.com</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>    <span class="n">stocks</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;stocks&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>            <span class="s1">&#39;access_key&#39;</span><span class="p">:</span> <span class="s1">&#39;b690ef1a94c38681861a3a78272a9c98&#39;</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>        <span class="p">}</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="n">api_result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://api.marketstack.com/v1/tickers/&#39;</span> <span class="o">+</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>        <span class="n">api_response</span> <span class="o">=</span> <span class="n">api_result</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">api_response</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>        <span class="n">newstock</span> <span class="o">=</span> <span class="n">stocks</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>                                          <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>        <span class="n">alcsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">newstock</span><span class="p">)</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>        <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>    <span class="s1">&#39;access_key&#39;</span><span class="p">:</span> <span class="s1">&#39;b690ef1a94c38681861a3a78272a9c98&#39;</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>    <span class="p">}</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>    <span class="n">api_result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://api.marketstack.com/v1/tickers/&#39;</span> <span class="o">+</span> <span class="n">ticker</span> <span class="o">+</span> <span class="s1">&#39;/eod/latest&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>    <span class="n">api_response</span> <span class="o">=</span> <span class="n">api_result</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>    <span class="k">return</span> <span class="n">api_response</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="k">def</span> <span class="nf">users</span><span class="p">():</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a><span class="sd">    Adds a user to the database if they are logged in</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>    <span class="n">users</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>    <span class="n">statement</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">users</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>    <span class="n">allusers</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">row</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">statement</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="p">):</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>        <span class="n">userinfo</span> <span class="o">=</span> <span class="n">session_info</span><span class="p">()</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>        <span class="n">uid</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;sub&#39;</span><span class="p">]</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>        <span class="n">username</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="n">statement</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>                                          <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>                                          <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>        <span class="n">alcsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>        <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">)</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a><span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a><span class="sd">    Login endpoint</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a><span class="sd">    Returns to the callback endpoint</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>    <span class="k">return</span> <span class="n">oauth</span><span class="o">.</span><span class="n">auth0</span><span class="o">.</span><span class="n">authorize_redirect</span><span class="p">(</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>        <span class="n">redirect_uri</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;callback&quot;</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>    <span class="p">)</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/callback&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="k">def</span> <span class="nf">callback</span><span class="p">():</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a><span class="sd">    Callback endpoint</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a><span class="sd">    Creates token for session</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="sd">    Redirects to home</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>    <span class="n">token</span> <span class="o">=</span> <span class="n">oauth</span><span class="o">.</span><span class="n">auth0</span><span class="o">.</span><span class="n">authorize_access_token</span><span class="p">()</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>    <span class="n">users</span><span class="p">()</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/logout&quot;</span><span class="p">)</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a><span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a><span class="sd">    Logout endpoint</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="sd">    Clears the sessions and redirects to home</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>    <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>        <span class="s2">&quot;https://&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AUTH0_DOMAIN&quot;</span><span class="p">)</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>        <span class="o">+</span> <span class="s2">&quot;/v2/logout?&quot;</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>        <span class="o">+</span> <span class="n">urlencode</span><span class="p">(</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>            <span class="p">{</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>                <span class="s2">&quot;returnTo&quot;</span><span class="p">:</span> <span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>                <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AUTH0_CLIENT_ID&quot;</span><span class="p">),</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>            <span class="p">},</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>            <span class="n">quote_via</span><span class="o">=</span><span class="n">quote_plus</span><span class="p">,</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>        <span class="p">)</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>    <span class="p">)</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/leaderboard&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a><span class="k">def</span> <span class="nf">leaderboard</span><span class="p">():</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a><span class="sd">    Andrew S. and Ryan Edwards</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a><span class="sd">    When this endpoint is hit, a zipped return of 3 lists is returned</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a><span class="sd">    The 3 lists contain the usernames, portfolio return percentage, and leaderboard position</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a><span class="sd">    of all of the users in the database</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a><span class="sd">    The usernames are found in the first sqlalchemy query, and stored in the users list</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a><span class="sd">    The return percentages are then found by taking the total_invested field from the first sqlalchemy</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a><span class="sd">    query, and comparing it to the current_amounts. The result of this is stored in the percentages list.</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a><span class="sd">    The indecies are found by generating a list of indecies for how many people are in the list, and </span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="sd">    then simply sorting the list later.</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a><span class="sd">    Once the users, percentages, and indecies lists are filled with the data, all 3 are sorted in the same way.</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a><span class="sd">    The 3 sorted lists are then zipped, so all 3 can be returned to be displayed on the home page.</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>    <span class="c1"># These are the 3 tables the sqlalchemy queries will need to use</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>    <span class="n">portfolios</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;portfolios&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>    <span class="n">users</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>    <span class="n">stocks</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;stocks&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>    <span class="c1"># This query gets the primary key, username, and the total amount invested for each user in the database</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>    <span class="n">sqlInvested</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">portfolioid</span><span class="p">,</span> <span class="n">users</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">initvalue</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;total_invested&#39;</span><span class="p">)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">users</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">uid</span> <span class="o">==</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">portfolioid</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">portfolioid</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>    <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>    <span class="c1"># These are all of the lists where data will be stored</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>    <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Array to hold the users from the database</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>    <span class="n">invested</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Array to hold total amount invested by each user</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>    <span class="n">current_amounts</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Array to hold current amount user&#39;s stocks are worth</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>    <span class="n">percentages</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds percentage for each user up/down</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>    <span class="n">usernames</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds usernames</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>    <span class="n">tickers</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds a list of tickers for each user</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>    <span class="n">indecies</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Indexs for return</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>    <span class="c1"># Saves the returned data from the first sqlachemy query in the lists</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">sqlInvested</span><span class="p">:</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>        <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">portfolioid</span><span class="p">)</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>        <span class="n">usernames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>        <span class="n">invested</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">total_invested</span><span class="p">)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>    <span class="c1"># This query gets the primary key for who bought each stock, and then how much of the stock was bought.</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>    <span class="c1"># It also gets the ticker, so we can use it to find the current amount of the stock now.</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>    <span class="n">getTickers</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">portfolioid</span><span class="p">,</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="n">stocks</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">ticker</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stocks</span><span class="p">,</span> <span class="n">stocks</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">stockid</span> <span class="o">==</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">stockid</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>    <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>    <span class="c1"># Goes through all of the tickers that we just got from the previous query.</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>    <span class="c1"># Goes through each user stored in the users list earlier.</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>    <span class="c1"># If the primary key matches the user we are current searching for, we hit the api</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>    <span class="c1"># to find the current price of the stock, and multiply it by the original quantity.</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>    <span class="c1"># The total is then added onto the total variable, and at the end, the total</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>    <span class="c1"># is stored in the current_amounts list.</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)):</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">getTickers</span><span class="p">:</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">portfolioid</span> <span class="o">==</span> <span class="n">users</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>                <span class="n">api_reponse</span> <span class="o">=</span> <span class="n">stockAPI</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">ticker</span><span class="p">)</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">api_reponse</span><span class="p">)</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>                <span class="n">init_value</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>                <span class="n">init_value</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">api_reponse</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">)</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>                <span class="n">total</span> <span class="o">+=</span> <span class="n">init_value</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>        <span class="n">current_amounts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>    <span class="c1"># Takes the current amount of the stocks - the total cost of the stocks to begin with, and divides it by</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>    <span class="c1"># the total amount initially. Multiplying it by 100 then gives us the percentage up/down for each user</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)):</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>        <span class="n">percentages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">current_amounts</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">invested</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">invested</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>    <span class="c1"># Simply generates a list of how many indecies we need</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>    <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)):</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>        <span class="n">indecies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>    <span class="c1"># https://stackoverflow.com/questions/19931975/sort-multiple-lists-simultaneously</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>    <span class="c1"># This helped me sort 2 lists the same way</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>    <span class="c1"># Sorts the 3 lists that we need to return the same way. Now, the 3 lists that were created are all sorted the same way,</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>    <span class="c1"># in order, and can be returned</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>    <span class="n">percentages_sorted</span><span class="p">,</span> <span class="n">usernames_sorted</span><span class="p">,</span> <span class="n">indecies_sorted</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">percentages</span><span class="p">,</span> <span class="n">usernames</span><span class="p">,</span> <span class="n">indecies</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>    <span class="c1"># This actually sorts the indecies list, so now each person has the correct index for leaderboard position</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>    <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">indecies</span><span class="p">)):</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>        <span class="n">indecies_sorted</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>    <span class="c1"># Zips all 3 lists so they can be returned to the front end</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>    <span class="n">sortedreturn</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">percentages_sorted</span><span class="p">,</span> <span class="n">usernames_sorted</span><span class="p">,</span> <span class="n">indecies_sorted</span><span class="p">)</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>    <span class="c1"># Returns the 3 lists</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>    <span class="k">return</span> <span class="n">sortedreturn</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a><span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a><span class="sd">    Home endpoint</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a><span class="sd">    Returns user to the home page and returns leaderboard with it.</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>    <span class="n">leaderboardlist</span> <span class="o">=</span> <span class="n">leaderboard</span><span class="p">()</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;index.html&quot;</span><span class="p">,</span> <span class="n">leaderboardlist</span><span class="o">=</span><span class="n">leaderboardlist</span><span class="p">)</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/profile&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a><span class="k">def</span> <span class="nf">profile</span><span class="p">():</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a><span class="sd">    Profile endpoint</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a><span class="sd">    Returns user session info on GET request</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a><span class="sd">    ---------------------------------------------</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a><span class="sd">    Changes applicable data on POST request and </span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a><span class="sd">    redirects to the GET request.</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>    <span class="n">users</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="p">):</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>        <span class="n">userinfo</span> <span class="o">=</span> <span class="n">session_info</span><span class="p">()</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>        <span class="n">uid</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;sub&#39;</span><span class="p">]</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>        <span class="n">username</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>        <span class="n">picture</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;picture&#39;</span><span class="p">]</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PATH  TO PICTURE: &quot;</span><span class="p">,</span> <span class="n">picture</span><span class="p">)</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">):</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>            <span class="n">statement</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">users</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;profile.html&quot;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>                                                    <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>                                                    <span class="n">picture</span><span class="o">=</span><span class="n">picture</span><span class="p">)</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">):</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>            <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>            <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>            <span class="n">statement</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">users</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>                                                                          <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>            <span class="n">alcsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>            <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/profile&quot;</span><span class="p">)</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">)</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/stockinfo&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a><span class="k">def</span> <span class="nf">pullstockinfo</span><span class="p">():</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a><span class="sd">    Endpoint returns information on a ticker that is entered into the </span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a><span class="sd">    search bar. It makes a call to marketstack API for the information.</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>    <span class="n">ticker</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>    <span class="n">stocks</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;stocks&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>    <span class="c1"># This query populates the stocks table if the ticker does not exist in it.</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>    <span class="c1"># It stores the ticker and name of the stock.</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>            <span class="s1">&#39;access_key&#39;</span><span class="p">:</span> <span class="s1">&#39;b690ef1a94c38681861a3a78272a9c98&#39;</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>        <span class="p">}</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>        <span class="n">api_result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://api.marketstack.com/v1/tickers/&#39;</span> <span class="o">+</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>        <span class="n">api_response</span> <span class="o">=</span> <span class="n">api_result</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">api_response</span><span class="p">)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">api_response</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>        <span class="n">newstock</span> <span class="o">=</span> <span class="n">stocks</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>                                          <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>        <span class="n">alcsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">newstock</span><span class="p">)</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>        <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>    <span class="c1"># This call to the API gets the latest EOD data of the ticker</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>    <span class="s1">&#39;access_key&#39;</span><span class="p">:</span> <span class="s1">&#39;b690ef1a94c38681861a3a78272a9c98&#39;</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>    <span class="p">}</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>    <span class="n">info_result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://api.marketstack.com/v1/tickers/&#39;</span> <span class="o">+</span> <span class="n">ticker</span> <span class="o">+</span> <span class="s1">&#39;/eod/latest&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>    <span class="n">name_result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://api.marketstack.com/v1/tickers/&#39;</span> <span class="o">+</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>    <span class="n">stock_info</span> <span class="o">=</span> <span class="n">info_result</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>    <span class="n">stock_name</span> <span class="o">=</span> <span class="n">name_result</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>    <span class="n">date</span> <span class="o">=</span> <span class="n">stock_info</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">stock_name</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>    <span class="n">openprice</span> <span class="o">=</span> <span class="n">stock_info</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>    <span class="n">close</span> <span class="o">=</span> <span class="n">stock_info</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>    <span class="n">high</span> <span class="o">=</span> <span class="n">stock_info</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>    <span class="n">low</span> <span class="o">=</span> <span class="n">stock_info</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>    <span class="n">volume</span> <span class="o">=</span> <span class="n">stock_info</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>    <span class="n">dividend</span> <span class="o">=</span> <span class="n">stock_info</span><span class="p">[</span><span class="s1">&#39;dividend&#39;</span><span class="p">]</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>    <span class="n">stock</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">stock_info</span><span class="p">,</span> <span class="n">stock_name</span><span class="p">])</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;stockinfo.html&quot;</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>                                             <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>                                             <span class="n">openprice</span><span class="o">=</span><span class="n">openprice</span><span class="p">,</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>                                             <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>                                             <span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>                                             <span class="n">volume</span><span class="o">=</span><span class="n">volume</span><span class="p">,</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>                                             <span class="n">dividend</span><span class="o">=</span><span class="n">dividend</span><span class="p">,</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>                                             <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">)</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/portfolio&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a><span class="k">def</span> <span class="nf">portfolio</span><span class="p">():</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a><span class="sd">    Portfolio endpoint</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a><span class="sd">    Handles interactions with a user&#39;s portfolio</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a><span class="sd">    Determines whether the request is a POST or GET request</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a><span class="sd">    and makes changes based on form data.</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a><span class="sd">    Allows naming of portfolios.</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>    <span class="n">users</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>    <span class="n">userstocks</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;userstocks&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>    <span class="n">portfolios</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;portfolios&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>    <span class="n">stocks</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;stocks&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>    <span class="c1"># Checks if a session is active</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="p">):</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>        <span class="n">userinfo</span> <span class="o">=</span> <span class="n">session_info</span><span class="p">()</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>        <span class="n">uid</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;sub&#39;</span><span class="p">]</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">users</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">uid</span> <span class="o">=</span> <span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>        <span class="n">uid</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>        <span class="c1"># get portfolio from sqlalchemy query</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>        <span class="n">existsconn</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">userstocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">portfolioid</span> <span class="o">=</span> <span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>        <span class="n">existsportfolio</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">portfolioid</span> <span class="o">=</span> <span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>        <span class="c1"># Keeping track of portfolios for users</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>        <span class="c1"># Sets the active portfolio to the first index of portfolionames</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>        <span class="n">portfolionames</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">existsportfolio</span><span class="p">:</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>            <span class="n">portfolionames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>            <span class="n">activeportfolio</span> <span class="o">=</span> <span class="n">portfolionames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>            <span class="n">activeportfolio</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>        <span class="c1"># If the request type is a post request, go here.</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">):</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>          <span class="n">ticker</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>          <span class="n">status</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;changelist&#39;</span><span class="p">]</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>          <span class="n">stockidexist</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">stockid</span> <span class="o">=</span> <span class="n">ticker</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>          <span class="n">tickerexist</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>          <span class="c1"># If form response value matches, change portfolio values</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>          <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Change Portfolio&quot;</span><span class="p">):</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>              <span class="n">activeportfolio</span> <span class="o">=</span> <span class="n">ticker</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>              <span class="n">getname</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">portfolioid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>                                                                <span class="n">name</span><span class="o">=</span><span class="n">ticker</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>              <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>              <span class="n">curr_val</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>              <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">getname</span><span class="p">:</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>                  <span class="n">stockdata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>                  <span class="n">result</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">stockid</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">stockid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>                  <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;stockid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">stockid</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>                  <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;stockname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>                  <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;buydate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">buydate</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>                  <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>                  <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;initvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">initvalue</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>                  <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;portname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>                  <span class="n">activeportfolio</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>                  <span class="n">curr_val</span> <span class="o">+=</span> <span class="n">stock_curr_val</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>                  <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stockdata</span><span class="p">)</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>              <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;portfolio.html&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>                                                        <span class="n">curr_val</span><span class="o">=</span><span class="n">curr_val</span><span class="p">,</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>                                                        <span class="n">portfolionames</span><span class="o">=</span><span class="n">portfolionames</span><span class="p">,</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>                                                        <span class="n">activeportfolio</span><span class="o">=</span><span class="n">activeportfolio</span><span class="p">)</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>          <span class="c1"># If response value matches, remove stock from portfolio and redirect to portfolio page.</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>          <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Remove Portfolio&quot;</span><span class="p">):</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>              <span class="k">try</span><span class="p">:</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>                  <span class="n">portfremove</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">portfolioid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">stockid</span><span class="o">=</span><span class="n">tickerexist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>                  <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>                  <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/portfolio&quot;</span><span class="p">)</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>              <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>                  <span class="n">portfremove</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">portfolioid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">stockid</span><span class="o">=</span><span class="n">stockidexist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>                  <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>                  <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/portfolio&quot;</span><span class="p">)</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>          <span class="c1"># If response value matches, add the stock to the specific portfolio</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>          <span class="c1"># NOTE: Buydate cannot be further than 5 years from the current day</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>          <span class="c1"># due to API tier limits.</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>          <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Add Portfolio&quot;</span><span class="p">):</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>            <span class="c1"># buydate must be strictly in yyy-mm-dd format.</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>            <span class="c1"># ex. 2015-12-25 (christmas 2015)</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>            <span class="c1"># Need to make sure input is correct or will get a bad request</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>            <span class="n">ticker</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>            <span class="n">buydate</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;buydate&#39;</span><span class="p">])</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>            <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">])</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>            <span class="n">portname</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;portname&#39;</span><span class="p">]</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>            <span class="n">initvalue</span> <span class="o">=</span> <span class="n">stock_init_val</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">buydate</span><span class="p">)</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>            <span class="n">portfadd</span> <span class="o">=</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">portfolioid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>                                                 <span class="n">stockid</span><span class="o">=</span><span class="n">tickerexist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>                                                 <span class="n">buydate</span><span class="o">=</span><span class="n">buydate</span><span class="p">,</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>                                                 <span class="n">quantity</span><span class="o">=</span><span class="n">quantity</span><span class="p">,</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>                                                 <span class="n">initvalue</span><span class="o">=</span><span class="n">initvalue</span><span class="p">,</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>                                                 <span class="n">name</span><span class="o">=</span><span class="n">portname</span><span class="p">)</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>            <span class="n">alcsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">portfadd</span><span class="p">)</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>            <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/portfolio&quot;</span><span class="p">)</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>        <span class="c1"># Returns active portfolio from session data</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">):</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>          <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>          <span class="n">curr_val</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>          <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">existsportfolio</span><span class="p">:</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>              <span class="n">stockdata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>              <span class="n">portname</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">stockid</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">stockid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">activeportfolio</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>              <span class="n">result</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">stockid</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">stockid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>              <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;stockid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">stockid</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>              <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;stockname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>              <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;buydate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">buydate</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>              <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>              <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;initvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">initvalue</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>              <span class="n">curr_val</span> <span class="o">+=</span> <span class="n">stock_curr_val</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>              <span class="nb">print</span><span class="p">(</span><span class="n">curr_val</span><span class="p">)</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>              <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stockdata</span><span class="p">)</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>          
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>          <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;portfolio.html&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>                                                    <span class="n">curr_val</span><span class="o">=</span><span class="n">curr_val</span><span class="p">,</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>                                                    <span class="n">activeportfolio</span><span class="o">=</span><span class="n">activeportfolio</span><span class="p">,</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>                                                    <span class="n">portfolionames</span><span class="o">=</span><span class="n">portfolionames</span><span class="p">)</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">)</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/watchlist&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a><span class="k">def</span> <span class="nf">watchlist</span><span class="p">():</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a><span class="sd">    Watchlist endpoint.</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a><span class="sd">    This endpoint functions similar to the portfolio endpoint.</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a><span class="sd">    It handles the names of watchlists and adding/removing </span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a><span class="sd">    them for users.</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>    <span class="n">users</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>    <span class="n">watchlists</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;watchlists&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>    <span class="n">userstocks</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;userstocks&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>    <span class="n">stocks</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;stocks&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="p">):</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>        <span class="n">userinfo</span> <span class="o">=</span> <span class="n">session_info</span><span class="p">()</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>        <span class="n">uid</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;sub&#39;</span><span class="p">]</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">users</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">uid</span> <span class="o">=</span> <span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>        <span class="n">uid</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>        <span class="n">existswatch</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">watchlists</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">wid</span> <span class="o">=</span> <span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>        <span class="c1"># Keeping track of watchlists for users</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>        <span class="c1"># sets active watchlist as first index</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>        <span class="n">watchlistnames</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>        <span class="k">for</span> <span class="n">row</span>  <span class="ow">in</span> <span class="n">existswatch</span><span class="p">:</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>            <span class="n">watchlistnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>            <span class="n">activewatchlist</span> <span class="o">=</span> <span class="n">watchlistnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>            <span class="n">activewatchlist</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>        <span class="c1"># this is used when the watchlist is being retrieved</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">):</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">existswatch</span><span class="p">:</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>                <span class="n">watchlistdata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>                    <span class="n">result</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">watchlists</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">stockid</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">stockid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">activewatchlist</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>                    <span class="n">stockname</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">stockid</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">stockid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>                    <span class="n">watchlistdata</span><span class="p">[</span><span class="s1">&#39;stockid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stockid</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>                    <span class="n">watchlistdata</span><span class="p">[</span><span class="s1">&#39;stockname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stockname</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>                    <span class="n">stockeod</span> <span class="o">=</span> <span class="n">stockAPI</span><span class="p">(</span><span class="n">stockname</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>                    <span class="n">watchlistdata</span><span class="p">[</span><span class="s1">&#39;currprice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stockeod</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">watchlistdata</span><span class="p">)</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>                    <span class="k">continue</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;WatchList.html&quot;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>                                                    <span class="n">watchlistnames</span><span class="o">=</span><span class="n">watchlistnames</span><span class="p">)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>        <span class="c1"># this is used when a stock is being added to the watchlist</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">):</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>            <span class="n">ticker</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>            <span class="n">status</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;changelist&#39;</span><span class="p">]</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>            <span class="n">tickerexist</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>            <span class="n">stockidexist</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">stockid</span> <span class="o">=</span> <span class="n">ticker</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>            <span class="c1"># Sets the active watchlist to the ticker value</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>            <span class="c1"># Uses this to find the new active watchlist.</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Change Watchlist&quot;</span><span class="p">):</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>                <span class="n">activewatchlist</span> <span class="o">=</span> <span class="n">ticker</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>                <span class="n">getname</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">watchlists</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">wid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>                                                                  <span class="n">name</span><span class="o">=</span><span class="n">ticker</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">getname</span><span class="p">:</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>                    <span class="n">watchlistdata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>                    <span class="n">result</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">watchlists</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">stockid</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">stockid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">activewatchlist</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>                    <span class="n">stockname</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">stockid</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">stockid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>                    <span class="n">watchlistdata</span><span class="p">[</span><span class="s1">&#39;stockid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">stockid</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>                    <span class="n">watchlistdata</span><span class="p">[</span><span class="s1">&#39;stockname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stockname</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>                    <span class="n">stockeod</span> <span class="o">=</span> <span class="n">stockAPI</span><span class="p">(</span><span class="n">stockname</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>                    <span class="n">watchlistdata</span><span class="p">[</span><span class="s1">&#39;currprice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stockeod</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">watchlistdata</span><span class="p">)</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>                <span class="c1">#return render_template(&quot;portfolio.html&quot;)</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>                <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;WatchList.html&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>                                                          <span class="n">watchlistnames</span><span class="o">=</span><span class="n">watchlistnames</span><span class="p">,</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>                                                          <span class="n">activewatchlist</span><span class="o">=</span><span class="n">activewatchlist</span><span class="p">)</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Remove Watchlist&quot;</span><span class="p">):</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>                    <span class="n">portfremove</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">watchlists</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">wid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">stockid</span><span class="o">=</span><span class="n">tickerexist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>                    <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/watchlist&quot;</span><span class="p">)</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>                    <span class="n">portfremove</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">watchlists</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">wid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">stockid</span><span class="o">=</span><span class="n">stockidexist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>                    <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/watchlist&quot;</span><span class="p">)</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Add Watchlist&quot;</span><span class="p">):</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>                <span class="n">watchname</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;watchname&#39;</span><span class="p">]</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>                <span class="n">watchlistinsert</span> <span class="o">=</span> <span class="n">watchlists</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>                                                   <span class="n">wid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>                                                   <span class="n">stockid</span><span class="o">=</span><span class="n">tickerexist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>                                                   <span class="n">name</span><span class="o">=</span><span class="n">watchname</span><span class="p">)</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>                <span class="n">alcsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">watchlistinsert</span><span class="p">)</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>                <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/watchlist&quot;</span><span class="p">)</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;WatchList.html&quot;</span><span class="p">,</span><span class="n">tickerexist</span><span class="o">=</span><span class="n">tickerexist</span><span class="p">)</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">)</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/snapshot&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">])</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a><span class="k">def</span> <span class="nf">snapshot</span><span class="p">():</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a><span class="sd">    Andrew, Ryan</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a><span class="sd">    When this endpoint is hit, an html file is returned that contains a mini snapshot of the current</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a><span class="sd">    user&#39;s profile. It contains the profile&#39;s image, the user&#39;s total portfolio return percentage up/down,</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a><span class="sd">    the user&#39;s best performing stock, and what percentage that stock is up/down.</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>    
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>    <span class="c1"># These are the 3 tables the sqlalchemy queries will need to use</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>    <span class="n">portfolios</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;portfolios&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>    <span class="n">users</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>    <span class="n">stocks</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;stocks&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>    <span class="c1"># check to make sure a session is active</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="p">):</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>        <span class="c1"># get user id from session info in sqlalchemy query</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>        <span class="n">sessioninfo</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>        <span class="n">pretty</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sessioninfo</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>        <span class="n">userinfo</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pretty</span><span class="p">)</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>        <span class="n">uid</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;sub&#39;</span><span class="p">]</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>        <span class="n">picture</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;picture&#39;</span><span class="p">]</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">users</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">uid</span> <span class="o">=</span> <span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>        <span class="n">uid</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>        <span class="c1"># This query gets the primary key, username, and the total amount invested for each user in the database</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>        <span class="n">sqlInvested</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">portfolioid</span><span class="p">,</span> <span class="n">users</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">initvalue</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;total_invested&#39;</span><span class="p">)</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">users</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">uid</span> <span class="o">==</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">portfolioid</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">portfolioid</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>        <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a>        <span class="c1"># These are all of the lists where data will be stored</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a>        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Array to hold the users from the database</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>        <span class="n">invested</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Array to hold total amount invested by each user</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a>        <span class="n">current_amounts</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Array to hold current amount user&#39;s stocks are worth</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>        <span class="n">percentages</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds percentage for each user up/down</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a>        <span class="n">usernames</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds usernames</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>        <span class="n">tickers</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds a list of tickers for each user</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>        <span class="n">userStocks</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds the current user&#39;s stocks</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>        <span class="n">currentValues</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds init values for each user stock</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>        <span class="n">differences</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds difference in init values for each stock</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>        <span class="n">previousValues</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds previous values for each stock</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>        <span class="c1"># Saves the returned data in the arrays</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">sqlInvested</span><span class="p">:</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>            <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">portfolioid</span><span class="p">)</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>            <span class="n">usernames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>            <span class="n">invested</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">total_invested</span><span class="p">)</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>        <span class="c1"># This query gets the primary key for who bought each stock, and then how much of the stock was bought.</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>        <span class="c1"># It also gets the ticker, so we can use it to find the current amount of the stock now.</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>        <span class="n">getTickers</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">portfolioid</span><span class="p">,</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="n">stocks</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">ticker</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stocks</span><span class="p">,</span> <span class="n">stocks</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">stockid</span> <span class="o">==</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">stockid</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">getTickers</span><span class="p">)</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a>        <span class="c1"># Goes through all of the tickers that we just got from the previous query.</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>        <span class="c1"># Goes through each user stored in the users list earlier.</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>        <span class="c1"># If the primary key matches the user we are current searching for, we hit the api</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a>        <span class="c1"># to find the current price of the stock, and multiply it by the original quantity.</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>        <span class="c1"># The total is then added onto the total variable, and at the end, the total</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>        <span class="c1"># is stored in the current_amounts list.</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)):</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a>            <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">getTickers</span><span class="p">:</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a>                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">portfolioid</span> <span class="o">==</span> <span class="n">users</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a>                    <span class="n">api_reponse</span> <span class="o">=</span> <span class="n">stockAPI</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">ticker</span><span class="p">)</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a>                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a>                    <span class="n">init_value</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a>                    <span class="n">init_value</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">api_reponse</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">)</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>                    <span class="n">total</span> <span class="o">+=</span> <span class="n">init_value</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a>            <span class="n">current_amounts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a>        <span class="c1"># Takes the current amount of the stocks - the total cost of the stocks to begin with, and divides it by</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a>        <span class="c1"># the total amount initially. Multiplying it by 100 then gives us the percentage up/down for each user</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)):</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a>            <span class="n">percentages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">current_amounts</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">invested</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">invested</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a>        <span class="c1"># https://stackoverflow.com/questions/19931975/sort-multiple-lists-simultaneously</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a>        <span class="c1"># Sort both lists in the same way</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a>        <span class="n">percentages_sorted</span><span class="p">,</span> <span class="n">users_sorted</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">percentages</span><span class="p">,</span> <span class="n">users</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a>        <span class="c1"># Gets user&#39;s current position on the leaderboard</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a>        <span class="c1"># Gets user&#39;s total portfolio return</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">users_sorted</span><span class="p">)):</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a>            <span class="k">if</span> <span class="n">users_sorted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span><span class="p">:</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a>                <span class="n">leaderboardPos</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a>                <span class="n">totalPortfolioReturn</span> <span class="o">=</span> <span class="n">percentages_sorted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a>        <span class="c1"># ----------------------------------------------------------------------</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a>        <span class="c1"># This part is for finding best performing stock</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a>        <span class="c1"># Query to get portfolio id, and stock info for all stocks in db</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a>        <span class="n">sqlInvested</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">portfolioid</span><span class="p">,</span> <span class="n">stocks</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="n">stocks</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">initvalue</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stocks</span><span class="p">,</span> <span class="n">stocks</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">stockid</span> <span class="o">==</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">stockid</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a>
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a>        <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a>
</span><span id="L-787"><a href="#L-787"><span class="linenos">787</span></a>        <span class="c1"># Get current init_values for all stocks</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos">788</span></a>        <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">sqlInvested</span><span class="p">:</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos">789</span></a>            <span class="k">if</span> <span class="n">stock</span><span class="o">.</span><span class="n">portfolioid</span> <span class="o">==</span> <span class="n">uid</span><span class="p">:</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos">790</span></a>                <span class="n">userStocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stock</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos">791</span></a>                <span class="n">previousValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stock</span><span class="o">.</span><span class="n">initvalue</span> <span class="o">/</span> <span class="n">stock</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos">792</span></a>                <span class="n">api_response</span> <span class="o">=</span> <span class="n">stockAPI</span><span class="p">(</span><span class="n">stock</span><span class="o">.</span><span class="n">ticker</span><span class="p">)</span>  <span class="c1"># Call api</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos">793</span></a>                <span class="n">init_value</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos">794</span></a>                <span class="n">init_value</span> <span class="o">=</span> <span class="n">stock</span><span class="o">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">api_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">)</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos">795</span></a>                <span class="n">currentValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">init_value</span><span class="p">)</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos">796</span></a>
</span><span id="L-797"><a href="#L-797"><span class="linenos">797</span></a>
</span><span id="L-798"><a href="#L-798"><span class="linenos">798</span></a>        <span class="c1"># Find the largest difference between init values (then vs. now)</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos">799</span></a>        <span class="c1"># We would then return the best performing stock, and how much percentage it is up</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos">800</span></a>        <span class="n">percentage</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos">801</span></a>        <span class="n">bestStock</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos">802</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentValues</span><span class="p">)):</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos">803</span></a>            <span class="n">differences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">currentValues</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">previousValues</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos">804</span></a>
</span><span id="L-805"><a href="#L-805"><span class="linenos">805</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">differences</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">percentage</span><span class="p">):</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos">806</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;differences done&quot;</span><span class="p">)</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos">807</span></a>                <span class="n">bestStock</span> <span class="o">=</span> <span class="n">userStocks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos">808</span></a>                <span class="n">percentage</span> <span class="o">=</span> <span class="n">differences</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos">809</span></a>
</span><span id="L-810"><a href="#L-810"><span class="linenos">810</span></a>
</span><span id="L-811"><a href="#L-811"><span class="linenos">811</span></a>        <span class="c1"># Returns the downloadable HTML file</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos">812</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;creating file&quot;</span><span class="p">)</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos">813</span></a>        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;stats.html&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos">814</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;html&gt;</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos">815</span></a><span class="s2">                    &lt;head&gt;</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos">816</span></a><span class="s2">                    &lt;title&gt;Stats&lt;/title&gt;</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos">817</span></a><span class="s2">                    &lt;/head&gt;</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos">818</span></a><span class="s2">                    &lt;body&gt;</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos">819</span></a>
</span><span id="L-820"><a href="#L-820"><span class="linenos">820</span></a><span class="s2">                    &lt;img src=</span><span class="si">{</span><span class="n">picture</span><span class="si">}</span><span class="s2">&gt;</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos">821</span></a><span class="s2">                    &lt;p style=&quot;font-weight:bold&quot;&gt;Total Portfolio Return: </span><span class="si">{</span><span class="n">totalPortfolioReturn</span><span class="si">}</span><span class="s2">&lt;/p&gt;</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos">822</span></a><span class="s2">                    &lt;p&gt;Leaderboard Position: </span><span class="si">{</span><span class="n">leaderboardPos</span><span class="si">}</span><span class="s2">&lt;/p&gt;</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos">823</span></a><span class="s2">                    &lt;p&gt;Best Stock: </span><span class="si">{</span><span class="n">bestStock</span><span class="si">}</span><span class="s2">&lt;/p&gt;</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos">824</span></a><span class="s2">                    &lt;p&gt;</span><span class="si">{</span><span class="n">bestStock</span><span class="si">}</span><span class="s2"> percentage: </span><span class="si">{</span><span class="n">percentage</span><span class="si">}</span><span class="s2">%&lt;/p&gt;</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos">825</span></a>
</span><span id="L-826"><a href="#L-826"><span class="linenos">826</span></a><span class="s2">                    &lt;/body&gt;</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos">827</span></a><span class="s2">                    &lt;/html&gt;</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos">828</span></a><span class="s2">                    &quot;&quot;&quot;</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos">829</span></a>        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos">830</span></a>        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos">831</span></a>
</span><span id="L-832"><a href="#L-832"><span class="linenos">832</span></a>        <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="s2">&quot;stats.html&quot;</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos">833</span></a>
</span><span id="L-834"><a href="#L-834"><span class="linenos">834</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos">835</span></a>        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">)</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos">836</span></a>
</span><span id="L-837"><a href="#L-837"><span class="linenos">837</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos">838</span></a><span class="k">def</span> <span class="nf">page_not_found</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos">839</span></a>
</span><span id="L-840"><a href="#L-840"><span class="linenos">840</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos">841</span></a><span class="sd">    Displays the 500.html error page, to actually handle errors</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos">842</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos">843</span></a>    <span class="k">return</span><span class="p">(</span><span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;500.html&quot;</span><span class="p">))</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos">844</span></a>
</span><span id="L-845"><a href="#L-845"><span class="linenos">845</span></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos">846</span></a>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PORT&quot;</span><span class="p">,</span> <span class="mi">3000</span><span class="p">))</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos">847</span></a>
</span><span id="L-848"><a href="#L-848"><span class="linenos">848</span></a><span class="n">app</span><span class="o">.</span><span class="n">static_folder</span> <span class="o">=</span> <span class="s1">&#39;static&#39;</span>
</span></pre></div>

        </details>

            </section>
                <section id="session_info">
                            <div class="attr function"><a class="headerlink" href="#session_info">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">session_info</span><span class="signature">()</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="session_info-43"><a href="#session_info-43"><span class="linenos">43</span></a><span class="k">def</span> <span class="nf">session_info</span><span class="p">():</span>
</span><span id="session_info-44"><a href="#session_info-44"><span class="linenos">44</span></a>    <span class="sd">&#39;&#39;&#39; </span>
</span><span id="session_info-45"><a href="#session_info-45"><span class="linenos">45</span></a><span class="sd">    Function returns current user&#39;s session information in JSON format. </span>
</span><span id="session_info-46"><a href="#session_info-46"><span class="linenos">46</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="session_info-47"><a href="#session_info-47"><span class="linenos">47</span></a>    <span class="n">sessioninfo</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
</span><span id="session_info-48"><a href="#session_info-48"><span class="linenos">48</span></a>    <span class="n">pretty</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sessioninfo</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span><span id="session_info-49"><a href="#session_info-49"><span class="linenos">49</span></a>    <span class="n">userinfo</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pretty</span><span class="p">)</span>
</span><span id="session_info-50"><a href="#session_info-50"><span class="linenos">50</span></a>    <span class="k">return</span> <span class="n">userinfo</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Function returns current user's session information in JSON format.</p>
</div>


                </section>
                <section id="stock_init_val">
                            <div class="attr function"><a class="headerlink" href="#stock_init_val">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">stock_init_val</span><span class="signature">(ticker, amount, buydate)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="stock_init_val-52"><a href="#stock_init_val-52"><span class="linenos">52</span></a><span class="k">def</span> <span class="nf">stock_init_val</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">buydate</span><span class="p">):</span>
</span><span id="stock_init_val-53"><a href="#stock_init_val-53"><span class="linenos">53</span></a>
</span><span id="stock_init_val-54"><a href="#stock_init_val-54"><span class="linenos">54</span></a>    <span class="sd">&#39;&#39;&#39; </span>
</span><span id="stock_init_val-55"><a href="#stock_init_val-55"><span class="linenos">55</span></a><span class="sd">    Function to get the initial purchase amount of a stock</span>
</span><span id="stock_init_val-56"><a href="#stock_init_val-56"><span class="linenos">56</span></a><span class="sd">    based on the buydate.</span>
</span><span id="stock_init_val-57"><a href="#stock_init_val-57"><span class="linenos">57</span></a><span class="sd">    Takes in a ticker, amount, and the buydate of the stock</span>
</span><span id="stock_init_val-58"><a href="#stock_init_val-58"><span class="linenos">58</span></a><span class="sd">    -----------------------------------------------------------</span>
</span><span id="stock_init_val-59"><a href="#stock_init_val-59"><span class="linenos">59</span></a><span class="sd">    NOTE: 5 year history limit. Buydate cannot be more than 5 years </span>
</span><span id="stock_init_val-60"><a href="#stock_init_val-60"><span class="linenos">60</span></a><span class="sd">    from the current day. </span>
</span><span id="stock_init_val-61"><a href="#stock_init_val-61"><span class="linenos">61</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="stock_init_val-62"><a href="#stock_init_val-62"><span class="linenos">62</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span>
</span><span id="stock_init_val-63"><a href="#stock_init_val-63"><span class="linenos">63</span></a>    <span class="c1"># getting the most recent stock data</span>
</span><span id="stock_init_val-64"><a href="#stock_init_val-64"><span class="linenos">64</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="stock_init_val-65"><a href="#stock_init_val-65"><span class="linenos">65</span></a>    <span class="s1">&#39;access_key&#39;</span><span class="p">:</span> <span class="s1">&#39;b690ef1a94c38681861a3a78272a9c98&#39;</span>
</span><span id="stock_init_val-66"><a href="#stock_init_val-66"><span class="linenos">66</span></a>    <span class="p">}</span>
</span><span id="stock_init_val-67"><a href="#stock_init_val-67"><span class="linenos">67</span></a>    <span class="n">route</span> <span class="o">=</span> <span class="s1">&#39;http://api.marketstack.com/v1/tickers/&#39;</span> <span class="o">+</span> <span class="n">ticker</span> <span class="o">+</span> <span class="s1">&#39;/eod/&#39;</span> <span class="o">+</span> <span class="n">buydate</span>
</span><span id="stock_init_val-68"><a href="#stock_init_val-68"><span class="linenos">68</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
</span><span id="stock_init_val-69"><a href="#stock_init_val-69"><span class="linenos">69</span></a>
</span><span id="stock_init_val-70"><a href="#stock_init_val-70"><span class="linenos">70</span></a>    <span class="n">api_buydate</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="stock_init_val-71"><a href="#stock_init_val-71"><span class="linenos">71</span></a>    <span class="n">buydate_info</span> <span class="o">=</span> <span class="n">api_buydate</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="stock_init_val-72"><a href="#stock_init_val-72"><span class="linenos">72</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">buydate_info</span><span class="p">)</span>
</span><span id="stock_init_val-73"><a href="#stock_init_val-73"><span class="linenos">73</span></a>
</span><span id="stock_init_val-74"><a href="#stock_init_val-74"><span class="linenos">74</span></a>    <span class="n">buydate_value</span> <span class="o">=</span> <span class="n">buydate_info</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">amount</span>
</span><span id="stock_init_val-75"><a href="#stock_init_val-75"><span class="linenos">75</span></a>
</span><span id="stock_init_val-76"><a href="#stock_init_val-76"><span class="linenos">76</span></a>    <span class="k">return</span> <span class="n">buydate_value</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Function to get the initial purchase amount of a stock
based on the buydate.</p>

<h2 id="takes-in-a-ticker-amount-and-the-buydate-of-the-stock">Takes in a ticker, amount, and the buydate of the stock</h2>

<p>NOTE: 5 year history limit. Buydate cannot be more than 5 years 
from the current day.</p>
</div>


                </section>
                <section id="stock_curr_val">
                            <div class="attr function"><a class="headerlink" href="#stock_curr_val">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">stock_curr_val</span><span class="signature">(ticker, amount)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="stock_curr_val-78"><a href="#stock_curr_val-78"><span class="linenos">78</span></a><span class="k">def</span> <span class="nf">stock_curr_val</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
</span><span id="stock_curr_val-79"><a href="#stock_curr_val-79"><span class="linenos">79</span></a>
</span><span id="stock_curr_val-80"><a href="#stock_curr_val-80"><span class="linenos">80</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="stock_curr_val-81"><a href="#stock_curr_val-81"><span class="linenos">81</span></a><span class="sd">    Function to get the current value of a portfolio holding</span>
</span><span id="stock_curr_val-82"><a href="#stock_curr_val-82"><span class="linenos">82</span></a><span class="sd">    Takes in a ticker and amount to calculate the current </span>
</span><span id="stock_curr_val-83"><a href="#stock_curr_val-83"><span class="linenos">83</span></a><span class="sd">    value.</span>
</span><span id="stock_curr_val-84"><a href="#stock_curr_val-84"><span class="linenos">84</span></a><span class="sd">    Returns the current value of the stock </span>
</span><span id="stock_curr_val-85"><a href="#stock_curr_val-85"><span class="linenos">85</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="stock_curr_val-86"><a href="#stock_curr_val-86"><span class="linenos">86</span></a>    <span class="c1"># getting the most recent stock data</span>
</span><span id="stock_curr_val-87"><a href="#stock_curr_val-87"><span class="linenos">87</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span>
</span><span id="stock_curr_val-88"><a href="#stock_curr_val-88"><span class="linenos">88</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="stock_curr_val-89"><a href="#stock_curr_val-89"><span class="linenos">89</span></a>    <span class="s1">&#39;access_key&#39;</span><span class="p">:</span> <span class="s1">&#39;b690ef1a94c38681861a3a78272a9c98&#39;</span>
</span><span id="stock_curr_val-90"><a href="#stock_curr_val-90"><span class="linenos">90</span></a>    <span class="p">}</span>
</span><span id="stock_curr_val-91"><a href="#stock_curr_val-91"><span class="linenos">91</span></a>    <span class="n">route</span> <span class="o">=</span> <span class="s1">&#39;http://api.marketstack.com/v1/tickers/&#39;</span> <span class="o">+</span> <span class="n">ticker</span> <span class="o">+</span> <span class="s1">&#39;/eod/latest&#39;</span>
</span><span id="stock_curr_val-92"><a href="#stock_curr_val-92"><span class="linenos">92</span></a>
</span><span id="stock_curr_val-93"><a href="#stock_curr_val-93"><span class="linenos">93</span></a>    <span class="n">api_current</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="stock_curr_val-94"><a href="#stock_curr_val-94"><span class="linenos">94</span></a>    <span class="n">curr_info</span> <span class="o">=</span> <span class="n">api_current</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="stock_curr_val-95"><a href="#stock_curr_val-95"><span class="linenos">95</span></a>
</span><span id="stock_curr_val-96"><a href="#stock_curr_val-96"><span class="linenos">96</span></a>    <span class="n">curr_val</span> <span class="o">=</span> <span class="n">curr_info</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">amount</span>
</span><span id="stock_curr_val-97"><a href="#stock_curr_val-97"><span class="linenos">97</span></a>
</span><span id="stock_curr_val-98"><a href="#stock_curr_val-98"><span class="linenos">98</span></a>    <span class="k">return</span> <span class="n">curr_val</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Function to get the current value of a portfolio holding
Takes in a ticker and amount to calculate the current 
value.
Returns the current value of the stock</p>
</div>


                </section>
                <section id="stockAPI">
                            <div class="attr function"><a class="headerlink" href="#stockAPI">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">stockAPI</span><span class="signature">(ticker)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="stockAPI-101"><a href="#stockAPI-101"><span class="linenos">101</span></a><span class="k">def</span> <span class="nf">stockAPI</span><span class="p">(</span><span class="n">ticker</span><span class="p">):</span>
</span><span id="stockAPI-102"><a href="#stockAPI-102"><span class="linenos">102</span></a>
</span><span id="stockAPI-103"><a href="#stockAPI-103"><span class="linenos">103</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="stockAPI-104"><a href="#stockAPI-104"><span class="linenos">104</span></a><span class="sd">    Function calls marketstack API for ticker information</span>
</span><span id="stockAPI-105"><a href="#stockAPI-105"><span class="linenos">105</span></a><span class="sd">    Takes in ticker and returns stock info in JSON format</span>
</span><span id="stockAPI-106"><a href="#stockAPI-106"><span class="linenos">106</span></a><span class="sd">    API link: https://marketstack.com</span>
</span><span id="stockAPI-107"><a href="#stockAPI-107"><span class="linenos">107</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="stockAPI-108"><a href="#stockAPI-108"><span class="linenos">108</span></a>    <span class="n">stocks</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;stocks&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="stockAPI-109"><a href="#stockAPI-109"><span class="linenos">109</span></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="stockAPI-110"><a href="#stockAPI-110"><span class="linenos">110</span></a>
</span><span id="stockAPI-111"><a href="#stockAPI-111"><span class="linenos">111</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
</span><span id="stockAPI-112"><a href="#stockAPI-112"><span class="linenos">112</span></a>
</span><span id="stockAPI-113"><a href="#stockAPI-113"><span class="linenos">113</span></a>        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="stockAPI-114"><a href="#stockAPI-114"><span class="linenos">114</span></a>            <span class="s1">&#39;access_key&#39;</span><span class="p">:</span> <span class="s1">&#39;b690ef1a94c38681861a3a78272a9c98&#39;</span>
</span><span id="stockAPI-115"><a href="#stockAPI-115"><span class="linenos">115</span></a>        <span class="p">}</span>
</span><span id="stockAPI-116"><a href="#stockAPI-116"><span class="linenos">116</span></a>
</span><span id="stockAPI-117"><a href="#stockAPI-117"><span class="linenos">117</span></a>        <span class="n">api_result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://api.marketstack.com/v1/tickers/&#39;</span> <span class="o">+</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="stockAPI-118"><a href="#stockAPI-118"><span class="linenos">118</span></a>        <span class="n">api_response</span> <span class="o">=</span> <span class="n">api_result</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="stockAPI-119"><a href="#stockAPI-119"><span class="linenos">119</span></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">api_response</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="stockAPI-120"><a href="#stockAPI-120"><span class="linenos">120</span></a>        <span class="n">newstock</span> <span class="o">=</span> <span class="n">stocks</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span>
</span><span id="stockAPI-121"><a href="#stockAPI-121"><span class="linenos">121</span></a>                                          <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</span><span id="stockAPI-122"><a href="#stockAPI-122"><span class="linenos">122</span></a>        <span class="n">alcsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">newstock</span><span class="p">)</span>
</span><span id="stockAPI-123"><a href="#stockAPI-123"><span class="linenos">123</span></a>        <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="stockAPI-124"><a href="#stockAPI-124"><span class="linenos">124</span></a>
</span><span id="stockAPI-125"><a href="#stockAPI-125"><span class="linenos">125</span></a>
</span><span id="stockAPI-126"><a href="#stockAPI-126"><span class="linenos">126</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="stockAPI-127"><a href="#stockAPI-127"><span class="linenos">127</span></a>    <span class="s1">&#39;access_key&#39;</span><span class="p">:</span> <span class="s1">&#39;b690ef1a94c38681861a3a78272a9c98&#39;</span>
</span><span id="stockAPI-128"><a href="#stockAPI-128"><span class="linenos">128</span></a>    <span class="p">}</span>
</span><span id="stockAPI-129"><a href="#stockAPI-129"><span class="linenos">129</span></a>
</span><span id="stockAPI-130"><a href="#stockAPI-130"><span class="linenos">130</span></a>    <span class="n">api_result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://api.marketstack.com/v1/tickers/&#39;</span> <span class="o">+</span> <span class="n">ticker</span> <span class="o">+</span> <span class="s1">&#39;/eod/latest&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="stockAPI-131"><a href="#stockAPI-131"><span class="linenos">131</span></a>    <span class="n">api_response</span> <span class="o">=</span> <span class="n">api_result</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="stockAPI-132"><a href="#stockAPI-132"><span class="linenos">132</span></a>
</span><span id="stockAPI-133"><a href="#stockAPI-133"><span class="linenos">133</span></a>    <span class="k">return</span> <span class="n">api_response</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Function calls marketstack API for ticker information
Takes in ticker and returns stock info in JSON format
API link: https://marketstack.com</p>
</div>


                </section>
                <section id="users">
                            <div class="attr function"><a class="headerlink" href="#users">#&nbsp;&nbsp</a>

                <div class="decorator">@app.route(&#39;/users&#39;, methods=[&#39;GET&#39;])</div>

            <span class="def">def</span>
            <span class="name">users</span><span class="signature">()</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="users-135"><a href="#users-135"><span class="linenos">135</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
</span><span id="users-136"><a href="#users-136"><span class="linenos">136</span></a><span class="k">def</span> <span class="nf">users</span><span class="p">():</span>
</span><span id="users-137"><a href="#users-137"><span class="linenos">137</span></a>
</span><span id="users-138"><a href="#users-138"><span class="linenos">138</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="users-139"><a href="#users-139"><span class="linenos">139</span></a><span class="sd">    Adds a user to the database if they are logged in</span>
</span><span id="users-140"><a href="#users-140"><span class="linenos">140</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="users-141"><a href="#users-141"><span class="linenos">141</span></a>    <span class="n">users</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="users-142"><a href="#users-142"><span class="linenos">142</span></a>    <span class="n">statement</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">users</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="users-143"><a href="#users-143"><span class="linenos">143</span></a>    <span class="n">allusers</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">row</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">statement</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span><span id="users-144"><a href="#users-144"><span class="linenos">144</span></a>
</span><span id="users-145"><a href="#users-145"><span class="linenos">145</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="p">):</span>
</span><span id="users-146"><a href="#users-146"><span class="linenos">146</span></a>        <span class="n">userinfo</span> <span class="o">=</span> <span class="n">session_info</span><span class="p">()</span>
</span><span id="users-147"><a href="#users-147"><span class="linenos">147</span></a>        <span class="n">uid</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;sub&#39;</span><span class="p">]</span>
</span><span id="users-148"><a href="#users-148"><span class="linenos">148</span></a>        <span class="n">username</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="users-149"><a href="#users-149"><span class="linenos">149</span></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
</span><span id="users-150"><a href="#users-150"><span class="linenos">150</span></a>
</span><span id="users-151"><a href="#users-151"><span class="linenos">151</span></a>        <span class="n">statement</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span>
</span><span id="users-152"><a href="#users-152"><span class="linenos">152</span></a>                                          <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
</span><span id="users-153"><a href="#users-153"><span class="linenos">153</span></a>                                          <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
</span><span id="users-154"><a href="#users-154"><span class="linenos">154</span></a>        <span class="n">alcsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
</span><span id="users-155"><a href="#users-155"><span class="linenos">155</span></a>        <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="users-156"><a href="#users-156"><span class="linenos">156</span></a>
</span><span id="users-157"><a href="#users-157"><span class="linenos">157</span></a>        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</span><span id="users-158"><a href="#users-158"><span class="linenos">158</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="users-159"><a href="#users-159"><span class="linenos">159</span></a>        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Adds a user to the database if they are logged in</p>
</div>


                </section>
                <section id="login">
                            <div class="attr function"><a class="headerlink" href="#login">#&nbsp;&nbsp</a>

                <div class="decorator">@app.route(&#39;/login&#39;)</div>

            <span class="def">def</span>
            <span class="name">login</span><span class="signature">()</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="login-162"><a href="#login-162"><span class="linenos">162</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">)</span>
</span><span id="login-163"><a href="#login-163"><span class="linenos">163</span></a><span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
</span><span id="login-164"><a href="#login-164"><span class="linenos">164</span></a>
</span><span id="login-165"><a href="#login-165"><span class="linenos">165</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="login-166"><a href="#login-166"><span class="linenos">166</span></a><span class="sd">    Login endpoint</span>
</span><span id="login-167"><a href="#login-167"><span class="linenos">167</span></a><span class="sd">    Returns to the callback endpoint</span>
</span><span id="login-168"><a href="#login-168"><span class="linenos">168</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="login-169"><a href="#login-169"><span class="linenos">169</span></a>    <span class="k">return</span> <span class="n">oauth</span><span class="o">.</span><span class="n">auth0</span><span class="o">.</span><span class="n">authorize_redirect</span><span class="p">(</span>
</span><span id="login-170"><a href="#login-170"><span class="linenos">170</span></a>        <span class="n">redirect_uri</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;callback&quot;</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="login-171"><a href="#login-171"><span class="linenos">171</span></a>    <span class="p">)</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Login endpoint
Returns to the callback endpoint</p>
</div>


                </section>
                <section id="callback">
                            <div class="attr function"><a class="headerlink" href="#callback">#&nbsp;&nbsp</a>

                <div class="decorator">@app.route(&#39;/callback&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])</div>

            <span class="def">def</span>
            <span class="name">callback</span><span class="signature">()</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="callback-173"><a href="#callback-173"><span class="linenos">173</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/callback&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
</span><span id="callback-174"><a href="#callback-174"><span class="linenos">174</span></a><span class="k">def</span> <span class="nf">callback</span><span class="p">():</span>
</span><span id="callback-175"><a href="#callback-175"><span class="linenos">175</span></a>
</span><span id="callback-176"><a href="#callback-176"><span class="linenos">176</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="callback-177"><a href="#callback-177"><span class="linenos">177</span></a><span class="sd">    Callback endpoint</span>
</span><span id="callback-178"><a href="#callback-178"><span class="linenos">178</span></a><span class="sd">    Creates token for session</span>
</span><span id="callback-179"><a href="#callback-179"><span class="linenos">179</span></a><span class="sd">    Redirects to home</span>
</span><span id="callback-180"><a href="#callback-180"><span class="linenos">180</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="callback-181"><a href="#callback-181"><span class="linenos">181</span></a>    <span class="n">token</span> <span class="o">=</span> <span class="n">oauth</span><span class="o">.</span><span class="n">auth0</span><span class="o">.</span><span class="n">authorize_access_token</span><span class="p">()</span>
</span><span id="callback-182"><a href="#callback-182"><span class="linenos">182</span></a>    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
</span><span id="callback-183"><a href="#callback-183"><span class="linenos">183</span></a>    <span class="n">users</span><span class="p">()</span>
</span><span id="callback-184"><a href="#callback-184"><span class="linenos">184</span></a>    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Callback endpoint
Creates token for session
Redirects to home</p>
</div>


                </section>
                <section id="logout">
                            <div class="attr function"><a class="headerlink" href="#logout">#&nbsp;&nbsp</a>

                <div class="decorator">@app.route(&#39;/logout&#39;)</div>

            <span class="def">def</span>
            <span class="name">logout</span><span class="signature">()</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="logout-186"><a href="#logout-186"><span class="linenos">186</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/logout&quot;</span><span class="p">)</span>
</span><span id="logout-187"><a href="#logout-187"><span class="linenos">187</span></a><span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
</span><span id="logout-188"><a href="#logout-188"><span class="linenos">188</span></a>
</span><span id="logout-189"><a href="#logout-189"><span class="linenos">189</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="logout-190"><a href="#logout-190"><span class="linenos">190</span></a><span class="sd">    Logout endpoint</span>
</span><span id="logout-191"><a href="#logout-191"><span class="linenos">191</span></a><span class="sd">    Clears the sessions and redirects to home</span>
</span><span id="logout-192"><a href="#logout-192"><span class="linenos">192</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="logout-193"><a href="#logout-193"><span class="linenos">193</span></a>    <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="logout-194"><a href="#logout-194"><span class="linenos">194</span></a>    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span>
</span><span id="logout-195"><a href="#logout-195"><span class="linenos">195</span></a>        <span class="s2">&quot;https://&quot;</span> <span class="o">+</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AUTH0_DOMAIN&quot;</span><span class="p">)</span>
</span><span id="logout-196"><a href="#logout-196"><span class="linenos">196</span></a>        <span class="o">+</span> <span class="s2">&quot;/v2/logout?&quot;</span>
</span><span id="logout-197"><a href="#logout-197"><span class="linenos">197</span></a>        <span class="o">+</span> <span class="n">urlencode</span><span class="p">(</span>
</span><span id="logout-198"><a href="#logout-198"><span class="linenos">198</span></a>            <span class="p">{</span>
</span><span id="logout-199"><a href="#logout-199"><span class="linenos">199</span></a>                <span class="s2">&quot;returnTo&quot;</span><span class="p">:</span> <span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="logout-200"><a href="#logout-200"><span class="linenos">200</span></a>                <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AUTH0_CLIENT_ID&quot;</span><span class="p">),</span>
</span><span id="logout-201"><a href="#logout-201"><span class="linenos">201</span></a>            <span class="p">},</span>
</span><span id="logout-202"><a href="#logout-202"><span class="linenos">202</span></a>            <span class="n">quote_via</span><span class="o">=</span><span class="n">quote_plus</span><span class="p">,</span>
</span><span id="logout-203"><a href="#logout-203"><span class="linenos">203</span></a>        <span class="p">)</span>
</span><span id="logout-204"><a href="#logout-204"><span class="linenos">204</span></a>    <span class="p">)</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Logout endpoint
Clears the sessions and redirects to home</p>
</div>


                </section>
                <section id="leaderboard">
                            <div class="attr function"><a class="headerlink" href="#leaderboard">#&nbsp;&nbsp</a>

                <div class="decorator">@app.route(&#39;/leaderboard&#39;, methods=[&#39;GET&#39;])</div>

            <span class="def">def</span>
            <span class="name">leaderboard</span><span class="signature">()</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="leaderboard-206"><a href="#leaderboard-206"><span class="linenos">206</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/leaderboard&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
</span><span id="leaderboard-207"><a href="#leaderboard-207"><span class="linenos">207</span></a><span class="k">def</span> <span class="nf">leaderboard</span><span class="p">():</span>
</span><span id="leaderboard-208"><a href="#leaderboard-208"><span class="linenos">208</span></a>
</span><span id="leaderboard-209"><a href="#leaderboard-209"><span class="linenos">209</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="leaderboard-210"><a href="#leaderboard-210"><span class="linenos">210</span></a><span class="sd">    Andrew S. and Ryan Edwards</span>
</span><span id="leaderboard-211"><a href="#leaderboard-211"><span class="linenos">211</span></a>
</span><span id="leaderboard-212"><a href="#leaderboard-212"><span class="linenos">212</span></a><span class="sd">    When this endpoint is hit, a zipped return of 3 lists is returned</span>
</span><span id="leaderboard-213"><a href="#leaderboard-213"><span class="linenos">213</span></a><span class="sd">    The 3 lists contain the usernames, portfolio return percentage, and leaderboard position</span>
</span><span id="leaderboard-214"><a href="#leaderboard-214"><span class="linenos">214</span></a><span class="sd">    of all of the users in the database</span>
</span><span id="leaderboard-215"><a href="#leaderboard-215"><span class="linenos">215</span></a><span class="sd">    The usernames are found in the first sqlalchemy query, and stored in the users list</span>
</span><span id="leaderboard-216"><a href="#leaderboard-216"><span class="linenos">216</span></a><span class="sd">    The return percentages are then found by taking the total_invested field from the first sqlalchemy</span>
</span><span id="leaderboard-217"><a href="#leaderboard-217"><span class="linenos">217</span></a><span class="sd">    query, and comparing it to the current_amounts. The result of this is stored in the percentages list.</span>
</span><span id="leaderboard-218"><a href="#leaderboard-218"><span class="linenos">218</span></a><span class="sd">    The indecies are found by generating a list of indecies for how many people are in the list, and </span>
</span><span id="leaderboard-219"><a href="#leaderboard-219"><span class="linenos">219</span></a><span class="sd">    then simply sorting the list later.</span>
</span><span id="leaderboard-220"><a href="#leaderboard-220"><span class="linenos">220</span></a><span class="sd">    Once the users, percentages, and indecies lists are filled with the data, all 3 are sorted in the same way.</span>
</span><span id="leaderboard-221"><a href="#leaderboard-221"><span class="linenos">221</span></a><span class="sd">    The 3 sorted lists are then zipped, so all 3 can be returned to be displayed on the home page.</span>
</span><span id="leaderboard-222"><a href="#leaderboard-222"><span class="linenos">222</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="leaderboard-223"><a href="#leaderboard-223"><span class="linenos">223</span></a>    <span class="c1"># These are the 3 tables the sqlalchemy queries will need to use</span>
</span><span id="leaderboard-224"><a href="#leaderboard-224"><span class="linenos">224</span></a>    <span class="n">portfolios</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;portfolios&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="leaderboard-225"><a href="#leaderboard-225"><span class="linenos">225</span></a>    <span class="n">users</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="leaderboard-226"><a href="#leaderboard-226"><span class="linenos">226</span></a>    <span class="n">stocks</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;stocks&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="leaderboard-227"><a href="#leaderboard-227"><span class="linenos">227</span></a>
</span><span id="leaderboard-228"><a href="#leaderboard-228"><span class="linenos">228</span></a>
</span><span id="leaderboard-229"><a href="#leaderboard-229"><span class="linenos">229</span></a>    <span class="c1"># This query gets the primary key, username, and the total amount invested for each user in the database</span>
</span><span id="leaderboard-230"><a href="#leaderboard-230"><span class="linenos">230</span></a>    <span class="n">sqlInvested</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">portfolioid</span><span class="p">,</span> <span class="n">users</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">initvalue</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;total_invested&#39;</span><span class="p">)</span>
</span><span id="leaderboard-231"><a href="#leaderboard-231"><span class="linenos">231</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">users</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">uid</span> <span class="o">==</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">portfolioid</span>
</span><span id="leaderboard-232"><a href="#leaderboard-232"><span class="linenos">232</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">portfolioid</span>
</span><span id="leaderboard-233"><a href="#leaderboard-233"><span class="linenos">233</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="leaderboard-234"><a href="#leaderboard-234"><span class="linenos">234</span></a>
</span><span id="leaderboard-235"><a href="#leaderboard-235"><span class="linenos">235</span></a>    <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="leaderboard-236"><a href="#leaderboard-236"><span class="linenos">236</span></a>
</span><span id="leaderboard-237"><a href="#leaderboard-237"><span class="linenos">237</span></a>
</span><span id="leaderboard-238"><a href="#leaderboard-238"><span class="linenos">238</span></a>    <span class="c1"># These are all of the lists where data will be stored</span>
</span><span id="leaderboard-239"><a href="#leaderboard-239"><span class="linenos">239</span></a>    <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Array to hold the users from the database</span>
</span><span id="leaderboard-240"><a href="#leaderboard-240"><span class="linenos">240</span></a>    <span class="n">invested</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Array to hold total amount invested by each user</span>
</span><span id="leaderboard-241"><a href="#leaderboard-241"><span class="linenos">241</span></a>    <span class="n">current_amounts</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Array to hold current amount user&#39;s stocks are worth</span>
</span><span id="leaderboard-242"><a href="#leaderboard-242"><span class="linenos">242</span></a>    <span class="n">percentages</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds percentage for each user up/down</span>
</span><span id="leaderboard-243"><a href="#leaderboard-243"><span class="linenos">243</span></a>    <span class="n">usernames</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds usernames</span>
</span><span id="leaderboard-244"><a href="#leaderboard-244"><span class="linenos">244</span></a>    <span class="n">tickers</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds a list of tickers for each user</span>
</span><span id="leaderboard-245"><a href="#leaderboard-245"><span class="linenos">245</span></a>    <span class="n">indecies</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Indexs for return</span>
</span><span id="leaderboard-246"><a href="#leaderboard-246"><span class="linenos">246</span></a>
</span><span id="leaderboard-247"><a href="#leaderboard-247"><span class="linenos">247</span></a>    <span class="c1"># Saves the returned data from the first sqlachemy query in the lists</span>
</span><span id="leaderboard-248"><a href="#leaderboard-248"><span class="linenos">248</span></a>    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">sqlInvested</span><span class="p">:</span>
</span><span id="leaderboard-249"><a href="#leaderboard-249"><span class="linenos">249</span></a>        <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">portfolioid</span><span class="p">)</span>
</span><span id="leaderboard-250"><a href="#leaderboard-250"><span class="linenos">250</span></a>        <span class="n">usernames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="leaderboard-251"><a href="#leaderboard-251"><span class="linenos">251</span></a>        <span class="n">invested</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">total_invested</span><span class="p">)</span>
</span><span id="leaderboard-252"><a href="#leaderboard-252"><span class="linenos">252</span></a>
</span><span id="leaderboard-253"><a href="#leaderboard-253"><span class="linenos">253</span></a>
</span><span id="leaderboard-254"><a href="#leaderboard-254"><span class="linenos">254</span></a>    <span class="c1"># This query gets the primary key for who bought each stock, and then how much of the stock was bought.</span>
</span><span id="leaderboard-255"><a href="#leaderboard-255"><span class="linenos">255</span></a>    <span class="c1"># It also gets the ticker, so we can use it to find the current amount of the stock now.</span>
</span><span id="leaderboard-256"><a href="#leaderboard-256"><span class="linenos">256</span></a>    <span class="n">getTickers</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">portfolioid</span><span class="p">,</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="n">stocks</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">ticker</span>
</span><span id="leaderboard-257"><a href="#leaderboard-257"><span class="linenos">257</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stocks</span><span class="p">,</span> <span class="n">stocks</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">stockid</span> <span class="o">==</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">stockid</span>
</span><span id="leaderboard-258"><a href="#leaderboard-258"><span class="linenos">258</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="leaderboard-259"><a href="#leaderboard-259"><span class="linenos">259</span></a>
</span><span id="leaderboard-260"><a href="#leaderboard-260"><span class="linenos">260</span></a>    <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="leaderboard-261"><a href="#leaderboard-261"><span class="linenos">261</span></a>
</span><span id="leaderboard-262"><a href="#leaderboard-262"><span class="linenos">262</span></a>    <span class="c1"># Goes through all of the tickers that we just got from the previous query.</span>
</span><span id="leaderboard-263"><a href="#leaderboard-263"><span class="linenos">263</span></a>    <span class="c1"># Goes through each user stored in the users list earlier.</span>
</span><span id="leaderboard-264"><a href="#leaderboard-264"><span class="linenos">264</span></a>    <span class="c1"># If the primary key matches the user we are current searching for, we hit the api</span>
</span><span id="leaderboard-265"><a href="#leaderboard-265"><span class="linenos">265</span></a>    <span class="c1"># to find the current price of the stock, and multiply it by the original quantity.</span>
</span><span id="leaderboard-266"><a href="#leaderboard-266"><span class="linenos">266</span></a>    <span class="c1"># The total is then added onto the total variable, and at the end, the total</span>
</span><span id="leaderboard-267"><a href="#leaderboard-267"><span class="linenos">267</span></a>    <span class="c1"># is stored in the current_amounts list.</span>
</span><span id="leaderboard-268"><a href="#leaderboard-268"><span class="linenos">268</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)):</span>
</span><span id="leaderboard-269"><a href="#leaderboard-269"><span class="linenos">269</span></a>        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="leaderboard-270"><a href="#leaderboard-270"><span class="linenos">270</span></a>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">getTickers</span><span class="p">:</span>
</span><span id="leaderboard-271"><a href="#leaderboard-271"><span class="linenos">271</span></a>            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">portfolioid</span> <span class="o">==</span> <span class="n">users</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="leaderboard-272"><a href="#leaderboard-272"><span class="linenos">272</span></a>                <span class="n">api_reponse</span> <span class="o">=</span> <span class="n">stockAPI</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">ticker</span><span class="p">)</span>
</span><span id="leaderboard-273"><a href="#leaderboard-273"><span class="linenos">273</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="leaderboard-274"><a href="#leaderboard-274"><span class="linenos">274</span></a>
</span><span id="leaderboard-275"><a href="#leaderboard-275"><span class="linenos">275</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">api_reponse</span><span class="p">)</span>
</span><span id="leaderboard-276"><a href="#leaderboard-276"><span class="linenos">276</span></a>                <span class="n">init_value</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="leaderboard-277"><a href="#leaderboard-277"><span class="linenos">277</span></a>                <span class="n">init_value</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">api_reponse</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">)</span>
</span><span id="leaderboard-278"><a href="#leaderboard-278"><span class="linenos">278</span></a>
</span><span id="leaderboard-279"><a href="#leaderboard-279"><span class="linenos">279</span></a>                <span class="n">total</span> <span class="o">+=</span> <span class="n">init_value</span>
</span><span id="leaderboard-280"><a href="#leaderboard-280"><span class="linenos">280</span></a>
</span><span id="leaderboard-281"><a href="#leaderboard-281"><span class="linenos">281</span></a>        <span class="n">current_amounts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
</span><span id="leaderboard-282"><a href="#leaderboard-282"><span class="linenos">282</span></a>
</span><span id="leaderboard-283"><a href="#leaderboard-283"><span class="linenos">283</span></a>
</span><span id="leaderboard-284"><a href="#leaderboard-284"><span class="linenos">284</span></a>
</span><span id="leaderboard-285"><a href="#leaderboard-285"><span class="linenos">285</span></a>    <span class="c1"># Takes the current amount of the stocks - the total cost of the stocks to begin with, and divides it by</span>
</span><span id="leaderboard-286"><a href="#leaderboard-286"><span class="linenos">286</span></a>    <span class="c1"># the total amount initially. Multiplying it by 100 then gives us the percentage up/down for each user</span>
</span><span id="leaderboard-287"><a href="#leaderboard-287"><span class="linenos">287</span></a>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)):</span>
</span><span id="leaderboard-288"><a href="#leaderboard-288"><span class="linenos">288</span></a>        <span class="n">percentages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">current_amounts</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">invested</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">invested</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="leaderboard-289"><a href="#leaderboard-289"><span class="linenos">289</span></a>
</span><span id="leaderboard-290"><a href="#leaderboard-290"><span class="linenos">290</span></a>    <span class="c1"># Simply generates a list of how many indecies we need</span>
</span><span id="leaderboard-291"><a href="#leaderboard-291"><span class="linenos">291</span></a>    <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)):</span>
</span><span id="leaderboard-292"><a href="#leaderboard-292"><span class="linenos">292</span></a>        <span class="n">indecies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="leaderboard-293"><a href="#leaderboard-293"><span class="linenos">293</span></a>
</span><span id="leaderboard-294"><a href="#leaderboard-294"><span class="linenos">294</span></a>
</span><span id="leaderboard-295"><a href="#leaderboard-295"><span class="linenos">295</span></a>    <span class="c1"># https://stackoverflow.com/questions/19931975/sort-multiple-lists-simultaneously</span>
</span><span id="leaderboard-296"><a href="#leaderboard-296"><span class="linenos">296</span></a>    <span class="c1"># This helped me sort 2 lists the same way</span>
</span><span id="leaderboard-297"><a href="#leaderboard-297"><span class="linenos">297</span></a>    <span class="c1"># Sorts the 3 lists that we need to return the same way. Now, the 3 lists that were created are all sorted the same way,</span>
</span><span id="leaderboard-298"><a href="#leaderboard-298"><span class="linenos">298</span></a>    <span class="c1"># in order, and can be returned</span>
</span><span id="leaderboard-299"><a href="#leaderboard-299"><span class="linenos">299</span></a>    <span class="n">percentages_sorted</span><span class="p">,</span> <span class="n">usernames_sorted</span><span class="p">,</span> <span class="n">indecies_sorted</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">percentages</span><span class="p">,</span> <span class="n">usernames</span><span class="p">,</span> <span class="n">indecies</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
</span><span id="leaderboard-300"><a href="#leaderboard-300"><span class="linenos">300</span></a>
</span><span id="leaderboard-301"><a href="#leaderboard-301"><span class="linenos">301</span></a>    <span class="c1"># This actually sorts the indecies list, so now each person has the correct index for leaderboard position</span>
</span><span id="leaderboard-302"><a href="#leaderboard-302"><span class="linenos">302</span></a>    <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">indecies</span><span class="p">)):</span>
</span><span id="leaderboard-303"><a href="#leaderboard-303"><span class="linenos">303</span></a>        <span class="n">indecies_sorted</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="leaderboard-304"><a href="#leaderboard-304"><span class="linenos">304</span></a>
</span><span id="leaderboard-305"><a href="#leaderboard-305"><span class="linenos">305</span></a>    <span class="c1"># Zips all 3 lists so they can be returned to the front end</span>
</span><span id="leaderboard-306"><a href="#leaderboard-306"><span class="linenos">306</span></a>    <span class="n">sortedreturn</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">percentages_sorted</span><span class="p">,</span> <span class="n">usernames_sorted</span><span class="p">,</span> <span class="n">indecies_sorted</span><span class="p">)</span>
</span><span id="leaderboard-307"><a href="#leaderboard-307"><span class="linenos">307</span></a>
</span><span id="leaderboard-308"><a href="#leaderboard-308"><span class="linenos">308</span></a>    <span class="c1"># Returns the 3 lists</span>
</span><span id="leaderboard-309"><a href="#leaderboard-309"><span class="linenos">309</span></a>    <span class="k">return</span> <span class="n">sortedreturn</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Andrew S. and Ryan Edwards</p>

<p>When this endpoint is hit, a zipped return of 3 lists is returned
The 3 lists contain the usernames, portfolio return percentage, and leaderboard position
of all of the users in the database
The usernames are found in the first sqlalchemy query, and stored in the users list
The return percentages are then found by taking the total_invested field from the first sqlalchemy
query, and comparing it to the current_amounts. The result of this is stored in the percentages list.
The indecies are found by generating a list of indecies for how many people are in the list, and 
then simply sorting the list later.
Once the users, percentages, and indecies lists are filled with the data, all 3 are sorted in the same way.
The 3 sorted lists are then zipped, so all 3 can be returned to be displayed on the home page.</p>
</div>


                </section>
                <section id="home">
                            <div class="attr function"><a class="headerlink" href="#home">#&nbsp;&nbsp</a>

                <div class="decorator">@app.route(&#39;/&#39;)</div>

            <span class="def">def</span>
            <span class="name">home</span><span class="signature">()</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="home-313"><a href="#home-313"><span class="linenos">313</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
</span><span id="home-314"><a href="#home-314"><span class="linenos">314</span></a><span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
</span><span id="home-315"><a href="#home-315"><span class="linenos">315</span></a>
</span><span id="home-316"><a href="#home-316"><span class="linenos">316</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="home-317"><a href="#home-317"><span class="linenos">317</span></a><span class="sd">    Home endpoint</span>
</span><span id="home-318"><a href="#home-318"><span class="linenos">318</span></a><span class="sd">    Returns user to the home page and returns leaderboard with it.</span>
</span><span id="home-319"><a href="#home-319"><span class="linenos">319</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="home-320"><a href="#home-320"><span class="linenos">320</span></a>    <span class="n">leaderboardlist</span> <span class="o">=</span> <span class="n">leaderboard</span><span class="p">()</span>
</span><span id="home-321"><a href="#home-321"><span class="linenos">321</span></a>    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;index.html&quot;</span><span class="p">,</span> <span class="n">leaderboardlist</span><span class="o">=</span><span class="n">leaderboardlist</span><span class="p">)</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Home endpoint
Returns user to the home page and returns leaderboard with it.</p>
</div>


                </section>
                <section id="profile">
                            <div class="attr function"><a class="headerlink" href="#profile">#&nbsp;&nbsp</a>

                <div class="decorator">@app.route(&#39;/profile&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])</div>

            <span class="def">def</span>
            <span class="name">profile</span><span class="signature">()</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="profile-323"><a href="#profile-323"><span class="linenos">323</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/profile&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span><span id="profile-324"><a href="#profile-324"><span class="linenos">324</span></a><span class="k">def</span> <span class="nf">profile</span><span class="p">():</span>
</span><span id="profile-325"><a href="#profile-325"><span class="linenos">325</span></a>
</span><span id="profile-326"><a href="#profile-326"><span class="linenos">326</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="profile-327"><a href="#profile-327"><span class="linenos">327</span></a><span class="sd">    Profile endpoint</span>
</span><span id="profile-328"><a href="#profile-328"><span class="linenos">328</span></a><span class="sd">    Returns user session info on GET request</span>
</span><span id="profile-329"><a href="#profile-329"><span class="linenos">329</span></a><span class="sd">    ---------------------------------------------</span>
</span><span id="profile-330"><a href="#profile-330"><span class="linenos">330</span></a><span class="sd">    Changes applicable data on POST request and </span>
</span><span id="profile-331"><a href="#profile-331"><span class="linenos">331</span></a><span class="sd">    redirects to the GET request.</span>
</span><span id="profile-332"><a href="#profile-332"><span class="linenos">332</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="profile-333"><a href="#profile-333"><span class="linenos">333</span></a>    <span class="n">users</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="profile-334"><a href="#profile-334"><span class="linenos">334</span></a>
</span><span id="profile-335"><a href="#profile-335"><span class="linenos">335</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="p">):</span>
</span><span id="profile-336"><a href="#profile-336"><span class="linenos">336</span></a>
</span><span id="profile-337"><a href="#profile-337"><span class="linenos">337</span></a>        <span class="n">userinfo</span> <span class="o">=</span> <span class="n">session_info</span><span class="p">()</span>
</span><span id="profile-338"><a href="#profile-338"><span class="linenos">338</span></a>        <span class="n">uid</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;sub&#39;</span><span class="p">]</span>
</span><span id="profile-339"><a href="#profile-339"><span class="linenos">339</span></a>        <span class="n">username</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="profile-340"><a href="#profile-340"><span class="linenos">340</span></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
</span><span id="profile-341"><a href="#profile-341"><span class="linenos">341</span></a>        <span class="n">picture</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;picture&#39;</span><span class="p">]</span>
</span><span id="profile-342"><a href="#profile-342"><span class="linenos">342</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PATH  TO PICTURE: &quot;</span><span class="p">,</span> <span class="n">picture</span><span class="p">)</span>
</span><span id="profile-343"><a href="#profile-343"><span class="linenos">343</span></a>
</span><span id="profile-344"><a href="#profile-344"><span class="linenos">344</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">):</span>
</span><span id="profile-345"><a href="#profile-345"><span class="linenos">345</span></a>            <span class="n">statement</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">users</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="profile-346"><a href="#profile-346"><span class="linenos">346</span></a>            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;profile.html&quot;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
</span><span id="profile-347"><a href="#profile-347"><span class="linenos">347</span></a>                                                    <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
</span><span id="profile-348"><a href="#profile-348"><span class="linenos">348</span></a>                                                    <span class="n">picture</span><span class="o">=</span><span class="n">picture</span><span class="p">)</span>
</span><span id="profile-349"><a href="#profile-349"><span class="linenos">349</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">):</span>
</span><span id="profile-350"><a href="#profile-350"><span class="linenos">350</span></a>
</span><span id="profile-351"><a href="#profile-351"><span class="linenos">351</span></a>            <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
</span><span id="profile-352"><a href="#profile-352"><span class="linenos">352</span></a>            <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
</span><span id="profile-353"><a href="#profile-353"><span class="linenos">353</span></a>
</span><span id="profile-354"><a href="#profile-354"><span class="linenos">354</span></a>            <span class="n">statement</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">users</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
</span><span id="profile-355"><a href="#profile-355"><span class="linenos">355</span></a>                                                                          <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
</span><span id="profile-356"><a href="#profile-356"><span class="linenos">356</span></a>            <span class="n">alcsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
</span><span id="profile-357"><a href="#profile-357"><span class="linenos">357</span></a>            <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="profile-358"><a href="#profile-358"><span class="linenos">358</span></a>
</span><span id="profile-359"><a href="#profile-359"><span class="linenos">359</span></a>            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/profile&quot;</span><span class="p">)</span>
</span><span id="profile-360"><a href="#profile-360"><span class="linenos">360</span></a>
</span><span id="profile-361"><a href="#profile-361"><span class="linenos">361</span></a>
</span><span id="profile-362"><a href="#profile-362"><span class="linenos">362</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="profile-363"><a href="#profile-363"><span class="linenos">363</span></a>        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">)</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Profile endpoint</p>

<h2 id="returns-user-session-info-on-get-request">Returns user session info on GET request</h2>

<p>Changes applicable data on POST request and 
redirects to the GET request.</p>
</div>


                </section>
                <section id="pullstockinfo">
                            <div class="attr function"><a class="headerlink" href="#pullstockinfo">#&nbsp;&nbsp</a>

                <div class="decorator">@app.route(&#39;/stockinfo&#39;, methods=[&#39;POST&#39;])</div>

            <span class="def">def</span>
            <span class="name">pullstockinfo</span><span class="signature">()</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="pullstockinfo-365"><a href="#pullstockinfo-365"><span class="linenos">365</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/stockinfo&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span><span id="pullstockinfo-366"><a href="#pullstockinfo-366"><span class="linenos">366</span></a><span class="k">def</span> <span class="nf">pullstockinfo</span><span class="p">():</span>
</span><span id="pullstockinfo-367"><a href="#pullstockinfo-367"><span class="linenos">367</span></a>
</span><span id="pullstockinfo-368"><a href="#pullstockinfo-368"><span class="linenos">368</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="pullstockinfo-369"><a href="#pullstockinfo-369"><span class="linenos">369</span></a><span class="sd">    Endpoint returns information on a ticker that is entered into the </span>
</span><span id="pullstockinfo-370"><a href="#pullstockinfo-370"><span class="linenos">370</span></a><span class="sd">    search bar. It makes a call to marketstack API for the information.</span>
</span><span id="pullstockinfo-371"><a href="#pullstockinfo-371"><span class="linenos">371</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="pullstockinfo-372"><a href="#pullstockinfo-372"><span class="linenos">372</span></a>    <span class="n">ticker</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]</span>
</span><span id="pullstockinfo-373"><a href="#pullstockinfo-373"><span class="linenos">373</span></a>
</span><span id="pullstockinfo-374"><a href="#pullstockinfo-374"><span class="linenos">374</span></a>    <span class="n">stocks</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;stocks&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="pullstockinfo-375"><a href="#pullstockinfo-375"><span class="linenos">375</span></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="pullstockinfo-376"><a href="#pullstockinfo-376"><span class="linenos">376</span></a>
</span><span id="pullstockinfo-377"><a href="#pullstockinfo-377"><span class="linenos">377</span></a>
</span><span id="pullstockinfo-378"><a href="#pullstockinfo-378"><span class="linenos">378</span></a>    <span class="c1"># This query populates the stocks table if the ticker does not exist in it.</span>
</span><span id="pullstockinfo-379"><a href="#pullstockinfo-379"><span class="linenos">379</span></a>    <span class="c1"># It stores the ticker and name of the stock.</span>
</span><span id="pullstockinfo-380"><a href="#pullstockinfo-380"><span class="linenos">380</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
</span><span id="pullstockinfo-381"><a href="#pullstockinfo-381"><span class="linenos">381</span></a>
</span><span id="pullstockinfo-382"><a href="#pullstockinfo-382"><span class="linenos">382</span></a>        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="pullstockinfo-383"><a href="#pullstockinfo-383"><span class="linenos">383</span></a>            <span class="s1">&#39;access_key&#39;</span><span class="p">:</span> <span class="s1">&#39;b690ef1a94c38681861a3a78272a9c98&#39;</span>
</span><span id="pullstockinfo-384"><a href="#pullstockinfo-384"><span class="linenos">384</span></a>        <span class="p">}</span>
</span><span id="pullstockinfo-385"><a href="#pullstockinfo-385"><span class="linenos">385</span></a>
</span><span id="pullstockinfo-386"><a href="#pullstockinfo-386"><span class="linenos">386</span></a>        <span class="n">api_result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://api.marketstack.com/v1/tickers/&#39;</span> <span class="o">+</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="pullstockinfo-387"><a href="#pullstockinfo-387"><span class="linenos">387</span></a>        <span class="n">api_response</span> <span class="o">=</span> <span class="n">api_result</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="pullstockinfo-388"><a href="#pullstockinfo-388"><span class="linenos">388</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">api_response</span><span class="p">)</span>
</span><span id="pullstockinfo-389"><a href="#pullstockinfo-389"><span class="linenos">389</span></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">api_response</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="pullstockinfo-390"><a href="#pullstockinfo-390"><span class="linenos">390</span></a>        <span class="n">newstock</span> <span class="o">=</span> <span class="n">stocks</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span>
</span><span id="pullstockinfo-391"><a href="#pullstockinfo-391"><span class="linenos">391</span></a>                                          <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</span><span id="pullstockinfo-392"><a href="#pullstockinfo-392"><span class="linenos">392</span></a>        <span class="n">alcsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">newstock</span><span class="p">)</span>
</span><span id="pullstockinfo-393"><a href="#pullstockinfo-393"><span class="linenos">393</span></a>        <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="pullstockinfo-394"><a href="#pullstockinfo-394"><span class="linenos">394</span></a>
</span><span id="pullstockinfo-395"><a href="#pullstockinfo-395"><span class="linenos">395</span></a>    <span class="c1"># This call to the API gets the latest EOD data of the ticker</span>
</span><span id="pullstockinfo-396"><a href="#pullstockinfo-396"><span class="linenos">396</span></a>    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="pullstockinfo-397"><a href="#pullstockinfo-397"><span class="linenos">397</span></a>    <span class="s1">&#39;access_key&#39;</span><span class="p">:</span> <span class="s1">&#39;b690ef1a94c38681861a3a78272a9c98&#39;</span>
</span><span id="pullstockinfo-398"><a href="#pullstockinfo-398"><span class="linenos">398</span></a>    <span class="p">}</span>
</span><span id="pullstockinfo-399"><a href="#pullstockinfo-399"><span class="linenos">399</span></a>
</span><span id="pullstockinfo-400"><a href="#pullstockinfo-400"><span class="linenos">400</span></a>    <span class="n">info_result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://api.marketstack.com/v1/tickers/&#39;</span> <span class="o">+</span> <span class="n">ticker</span> <span class="o">+</span> <span class="s1">&#39;/eod/latest&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="pullstockinfo-401"><a href="#pullstockinfo-401"><span class="linenos">401</span></a>    <span class="n">name_result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://api.marketstack.com/v1/tickers/&#39;</span> <span class="o">+</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="pullstockinfo-402"><a href="#pullstockinfo-402"><span class="linenos">402</span></a>    <span class="n">stock_info</span> <span class="o">=</span> <span class="n">info_result</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="pullstockinfo-403"><a href="#pullstockinfo-403"><span class="linenos">403</span></a>    <span class="n">stock_name</span> <span class="o">=</span> <span class="n">name_result</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="pullstockinfo-404"><a href="#pullstockinfo-404"><span class="linenos">404</span></a>
</span><span id="pullstockinfo-405"><a href="#pullstockinfo-405"><span class="linenos">405</span></a>    <span class="n">date</span> <span class="o">=</span> <span class="n">stock_info</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
</span><span id="pullstockinfo-406"><a href="#pullstockinfo-406"><span class="linenos">406</span></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">stock_name</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="pullstockinfo-407"><a href="#pullstockinfo-407"><span class="linenos">407</span></a>    <span class="n">openprice</span> <span class="o">=</span> <span class="n">stock_info</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span>
</span><span id="pullstockinfo-408"><a href="#pullstockinfo-408"><span class="linenos">408</span></a>    <span class="n">close</span> <span class="o">=</span> <span class="n">stock_info</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
</span><span id="pullstockinfo-409"><a href="#pullstockinfo-409"><span class="linenos">409</span></a>    <span class="n">high</span> <span class="o">=</span> <span class="n">stock_info</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span>
</span><span id="pullstockinfo-410"><a href="#pullstockinfo-410"><span class="linenos">410</span></a>    <span class="n">low</span> <span class="o">=</span> <span class="n">stock_info</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span>
</span><span id="pullstockinfo-411"><a href="#pullstockinfo-411"><span class="linenos">411</span></a>    <span class="n">volume</span> <span class="o">=</span> <span class="n">stock_info</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span>
</span><span id="pullstockinfo-412"><a href="#pullstockinfo-412"><span class="linenos">412</span></a>    <span class="n">dividend</span> <span class="o">=</span> <span class="n">stock_info</span><span class="p">[</span><span class="s1">&#39;dividend&#39;</span><span class="p">]</span>
</span><span id="pullstockinfo-413"><a href="#pullstockinfo-413"><span class="linenos">413</span></a>
</span><span id="pullstockinfo-414"><a href="#pullstockinfo-414"><span class="linenos">414</span></a>    <span class="n">stock</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">stock_info</span><span class="p">,</span> <span class="n">stock_name</span><span class="p">])</span>
</span><span id="pullstockinfo-415"><a href="#pullstockinfo-415"><span class="linenos">415</span></a>
</span><span id="pullstockinfo-416"><a href="#pullstockinfo-416"><span class="linenos">416</span></a>
</span><span id="pullstockinfo-417"><a href="#pullstockinfo-417"><span class="linenos">417</span></a>    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;stockinfo.html&quot;</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span>
</span><span id="pullstockinfo-418"><a href="#pullstockinfo-418"><span class="linenos">418</span></a>                                             <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
</span><span id="pullstockinfo-419"><a href="#pullstockinfo-419"><span class="linenos">419</span></a>                                             <span class="n">openprice</span><span class="o">=</span><span class="n">openprice</span><span class="p">,</span>
</span><span id="pullstockinfo-420"><a href="#pullstockinfo-420"><span class="linenos">420</span></a>                                             <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span>
</span><span id="pullstockinfo-421"><a href="#pullstockinfo-421"><span class="linenos">421</span></a>                                             <span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span>
</span><span id="pullstockinfo-422"><a href="#pullstockinfo-422"><span class="linenos">422</span></a>                                             <span class="n">volume</span><span class="o">=</span><span class="n">volume</span><span class="p">,</span>
</span><span id="pullstockinfo-423"><a href="#pullstockinfo-423"><span class="linenos">423</span></a>                                             <span class="n">dividend</span><span class="o">=</span><span class="n">dividend</span><span class="p">,</span>
</span><span id="pullstockinfo-424"><a href="#pullstockinfo-424"><span class="linenos">424</span></a>                                             <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">)</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Endpoint returns information on a ticker that is entered into the 
search bar. It makes a call to marketstack API for the information.</p>
</div>


                </section>
                <section id="portfolio">
                            <div class="attr function"><a class="headerlink" href="#portfolio">#&nbsp;&nbsp</a>

                <div class="decorator">@app.route(&#39;/portfolio&#39;, methods=[&#39;POST&#39;, &#39;GET&#39;])</div>

            <span class="def">def</span>
            <span class="name">portfolio</span><span class="signature">()</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="portfolio-426"><a href="#portfolio-426"><span class="linenos">426</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/portfolio&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
</span><span id="portfolio-427"><a href="#portfolio-427"><span class="linenos">427</span></a><span class="k">def</span> <span class="nf">portfolio</span><span class="p">():</span>
</span><span id="portfolio-428"><a href="#portfolio-428"><span class="linenos">428</span></a>
</span><span id="portfolio-429"><a href="#portfolio-429"><span class="linenos">429</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="portfolio-430"><a href="#portfolio-430"><span class="linenos">430</span></a><span class="sd">    Portfolio endpoint</span>
</span><span id="portfolio-431"><a href="#portfolio-431"><span class="linenos">431</span></a><span class="sd">    Handles interactions with a user&#39;s portfolio</span>
</span><span id="portfolio-432"><a href="#portfolio-432"><span class="linenos">432</span></a><span class="sd">    Determines whether the request is a POST or GET request</span>
</span><span id="portfolio-433"><a href="#portfolio-433"><span class="linenos">433</span></a><span class="sd">    and makes changes based on form data.</span>
</span><span id="portfolio-434"><a href="#portfolio-434"><span class="linenos">434</span></a><span class="sd">    Allows naming of portfolios.</span>
</span><span id="portfolio-435"><a href="#portfolio-435"><span class="linenos">435</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="portfolio-436"><a href="#portfolio-436"><span class="linenos">436</span></a>    <span class="n">users</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="portfolio-437"><a href="#portfolio-437"><span class="linenos">437</span></a>    <span class="n">userstocks</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;userstocks&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="portfolio-438"><a href="#portfolio-438"><span class="linenos">438</span></a>    <span class="n">portfolios</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;portfolios&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="portfolio-439"><a href="#portfolio-439"><span class="linenos">439</span></a>    <span class="n">stocks</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;stocks&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="portfolio-440"><a href="#portfolio-440"><span class="linenos">440</span></a>
</span><span id="portfolio-441"><a href="#portfolio-441"><span class="linenos">441</span></a>    <span class="c1"># Checks if a session is active</span>
</span><span id="portfolio-442"><a href="#portfolio-442"><span class="linenos">442</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="p">):</span>
</span><span id="portfolio-443"><a href="#portfolio-443"><span class="linenos">443</span></a>
</span><span id="portfolio-444"><a href="#portfolio-444"><span class="linenos">444</span></a>        <span class="n">userinfo</span> <span class="o">=</span> <span class="n">session_info</span><span class="p">()</span>
</span><span id="portfolio-445"><a href="#portfolio-445"><span class="linenos">445</span></a>        <span class="n">uid</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;sub&#39;</span><span class="p">]</span>
</span><span id="portfolio-446"><a href="#portfolio-446"><span class="linenos">446</span></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="portfolio-447"><a href="#portfolio-447"><span class="linenos">447</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">users</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">uid</span> <span class="o">=</span> <span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="portfolio-448"><a href="#portfolio-448"><span class="linenos">448</span></a>        <span class="n">uid</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="portfolio-449"><a href="#portfolio-449"><span class="linenos">449</span></a>
</span><span id="portfolio-450"><a href="#portfolio-450"><span class="linenos">450</span></a>        <span class="c1"># get portfolio from sqlalchemy query</span>
</span><span id="portfolio-451"><a href="#portfolio-451"><span class="linenos">451</span></a>        <span class="n">existsconn</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">userstocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">portfolioid</span> <span class="o">=</span> <span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="portfolio-452"><a href="#portfolio-452"><span class="linenos">452</span></a>        <span class="n">existsportfolio</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">portfolioid</span> <span class="o">=</span> <span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="portfolio-453"><a href="#portfolio-453"><span class="linenos">453</span></a>
</span><span id="portfolio-454"><a href="#portfolio-454"><span class="linenos">454</span></a>        <span class="c1"># Keeping track of portfolios for users</span>
</span><span id="portfolio-455"><a href="#portfolio-455"><span class="linenos">455</span></a>        <span class="c1"># Sets the active portfolio to the first index of portfolionames</span>
</span><span id="portfolio-456"><a href="#portfolio-456"><span class="linenos">456</span></a>        <span class="n">portfolionames</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="portfolio-457"><a href="#portfolio-457"><span class="linenos">457</span></a>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">existsportfolio</span><span class="p">:</span>
</span><span id="portfolio-458"><a href="#portfolio-458"><span class="linenos">458</span></a>            <span class="n">portfolionames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
</span><span id="portfolio-459"><a href="#portfolio-459"><span class="linenos">459</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="portfolio-460"><a href="#portfolio-460"><span class="linenos">460</span></a>            <span class="n">activeportfolio</span> <span class="o">=</span> <span class="n">portfolionames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="portfolio-461"><a href="#portfolio-461"><span class="linenos">461</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="portfolio-462"><a href="#portfolio-462"><span class="linenos">462</span></a>            <span class="n">activeportfolio</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="portfolio-463"><a href="#portfolio-463"><span class="linenos">463</span></a>
</span><span id="portfolio-464"><a href="#portfolio-464"><span class="linenos">464</span></a>        <span class="c1"># If the request type is a post request, go here.</span>
</span><span id="portfolio-465"><a href="#portfolio-465"><span class="linenos">465</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">):</span>
</span><span id="portfolio-466"><a href="#portfolio-466"><span class="linenos">466</span></a>
</span><span id="portfolio-467"><a href="#portfolio-467"><span class="linenos">467</span></a>          <span class="n">ticker</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]</span>
</span><span id="portfolio-468"><a href="#portfolio-468"><span class="linenos">468</span></a>          <span class="n">status</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;changelist&#39;</span><span class="p">]</span>
</span><span id="portfolio-469"><a href="#portfolio-469"><span class="linenos">469</span></a>          <span class="n">stockidexist</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">stockid</span> <span class="o">=</span> <span class="n">ticker</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="portfolio-470"><a href="#portfolio-470"><span class="linenos">470</span></a>          <span class="n">tickerexist</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="portfolio-471"><a href="#portfolio-471"><span class="linenos">471</span></a>
</span><span id="portfolio-472"><a href="#portfolio-472"><span class="linenos">472</span></a>          <span class="c1"># If form response value matches, change portfolio values</span>
</span><span id="portfolio-473"><a href="#portfolio-473"><span class="linenos">473</span></a>          <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Change Portfolio&quot;</span><span class="p">):</span>
</span><span id="portfolio-474"><a href="#portfolio-474"><span class="linenos">474</span></a>              <span class="n">activeportfolio</span> <span class="o">=</span> <span class="n">ticker</span>
</span><span id="portfolio-475"><a href="#portfolio-475"><span class="linenos">475</span></a>              <span class="n">getname</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">portfolioid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span>
</span><span id="portfolio-476"><a href="#portfolio-476"><span class="linenos">476</span></a>                                                                <span class="n">name</span><span class="o">=</span><span class="n">ticker</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="portfolio-477"><a href="#portfolio-477"><span class="linenos">477</span></a>
</span><span id="portfolio-478"><a href="#portfolio-478"><span class="linenos">478</span></a>              <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="portfolio-479"><a href="#portfolio-479"><span class="linenos">479</span></a>              <span class="n">curr_val</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="portfolio-480"><a href="#portfolio-480"><span class="linenos">480</span></a>              <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">getname</span><span class="p">:</span>
</span><span id="portfolio-481"><a href="#portfolio-481"><span class="linenos">481</span></a>                  <span class="n">stockdata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="portfolio-482"><a href="#portfolio-482"><span class="linenos">482</span></a>                  <span class="n">result</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">stockid</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">stockid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="portfolio-483"><a href="#portfolio-483"><span class="linenos">483</span></a>                  <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;stockid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">stockid</span>
</span><span id="portfolio-484"><a href="#portfolio-484"><span class="linenos">484</span></a>                  <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;stockname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="portfolio-485"><a href="#portfolio-485"><span class="linenos">485</span></a>                  <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;buydate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">buydate</span>
</span><span id="portfolio-486"><a href="#portfolio-486"><span class="linenos">486</span></a>                  <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="portfolio-487"><a href="#portfolio-487"><span class="linenos">487</span></a>                  <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;initvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">initvalue</span>
</span><span id="portfolio-488"><a href="#portfolio-488"><span class="linenos">488</span></a>                  <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;portname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
</span><span id="portfolio-489"><a href="#portfolio-489"><span class="linenos">489</span></a>                  <span class="n">activeportfolio</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
</span><span id="portfolio-490"><a href="#portfolio-490"><span class="linenos">490</span></a>
</span><span id="portfolio-491"><a href="#portfolio-491"><span class="linenos">491</span></a>                  <span class="n">curr_val</span> <span class="o">+=</span> <span class="n">stock_curr_val</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
</span><span id="portfolio-492"><a href="#portfolio-492"><span class="linenos">492</span></a>
</span><span id="portfolio-493"><a href="#portfolio-493"><span class="linenos">493</span></a>                  <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stockdata</span><span class="p">)</span>
</span><span id="portfolio-494"><a href="#portfolio-494"><span class="linenos">494</span></a>
</span><span id="portfolio-495"><a href="#portfolio-495"><span class="linenos">495</span></a>              <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;portfolio.html&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
</span><span id="portfolio-496"><a href="#portfolio-496"><span class="linenos">496</span></a>                                                        <span class="n">curr_val</span><span class="o">=</span><span class="n">curr_val</span><span class="p">,</span>
</span><span id="portfolio-497"><a href="#portfolio-497"><span class="linenos">497</span></a>                                                        <span class="n">portfolionames</span><span class="o">=</span><span class="n">portfolionames</span><span class="p">,</span>
</span><span id="portfolio-498"><a href="#portfolio-498"><span class="linenos">498</span></a>                                                        <span class="n">activeportfolio</span><span class="o">=</span><span class="n">activeportfolio</span><span class="p">)</span>
</span><span id="portfolio-499"><a href="#portfolio-499"><span class="linenos">499</span></a>
</span><span id="portfolio-500"><a href="#portfolio-500"><span class="linenos">500</span></a>          <span class="c1"># If response value matches, remove stock from portfolio and redirect to portfolio page.</span>
</span><span id="portfolio-501"><a href="#portfolio-501"><span class="linenos">501</span></a>          <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Remove Portfolio&quot;</span><span class="p">):</span>
</span><span id="portfolio-502"><a href="#portfolio-502"><span class="linenos">502</span></a>              <span class="k">try</span><span class="p">:</span>
</span><span id="portfolio-503"><a href="#portfolio-503"><span class="linenos">503</span></a>                  <span class="n">portfremove</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">portfolioid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">stockid</span><span class="o">=</span><span class="n">tickerexist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span id="portfolio-504"><a href="#portfolio-504"><span class="linenos">504</span></a>                  <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="portfolio-505"><a href="#portfolio-505"><span class="linenos">505</span></a>                  <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/portfolio&quot;</span><span class="p">)</span>
</span><span id="portfolio-506"><a href="#portfolio-506"><span class="linenos">506</span></a>              <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
</span><span id="portfolio-507"><a href="#portfolio-507"><span class="linenos">507</span></a>                  <span class="n">portfremove</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">portfolioid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">stockid</span><span class="o">=</span><span class="n">stockidexist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span id="portfolio-508"><a href="#portfolio-508"><span class="linenos">508</span></a>                  <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="portfolio-509"><a href="#portfolio-509"><span class="linenos">509</span></a>                  <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/portfolio&quot;</span><span class="p">)</span>
</span><span id="portfolio-510"><a href="#portfolio-510"><span class="linenos">510</span></a>
</span><span id="portfolio-511"><a href="#portfolio-511"><span class="linenos">511</span></a>
</span><span id="portfolio-512"><a href="#portfolio-512"><span class="linenos">512</span></a>
</span><span id="portfolio-513"><a href="#portfolio-513"><span class="linenos">513</span></a>          <span class="c1"># If response value matches, add the stock to the specific portfolio</span>
</span><span id="portfolio-514"><a href="#portfolio-514"><span class="linenos">514</span></a>          <span class="c1"># NOTE: Buydate cannot be further than 5 years from the current day</span>
</span><span id="portfolio-515"><a href="#portfolio-515"><span class="linenos">515</span></a>          <span class="c1"># due to API tier limits.</span>
</span><span id="portfolio-516"><a href="#portfolio-516"><span class="linenos">516</span></a>          <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Add Portfolio&quot;</span><span class="p">):</span>
</span><span id="portfolio-517"><a href="#portfolio-517"><span class="linenos">517</span></a>
</span><span id="portfolio-518"><a href="#portfolio-518"><span class="linenos">518</span></a>            <span class="c1"># buydate must be strictly in yyy-mm-dd format.</span>
</span><span id="portfolio-519"><a href="#portfolio-519"><span class="linenos">519</span></a>            <span class="c1"># ex. 2015-12-25 (christmas 2015)</span>
</span><span id="portfolio-520"><a href="#portfolio-520"><span class="linenos">520</span></a>
</span><span id="portfolio-521"><a href="#portfolio-521"><span class="linenos">521</span></a>            <span class="c1"># Need to make sure input is correct or will get a bad request</span>
</span><span id="portfolio-522"><a href="#portfolio-522"><span class="linenos">522</span></a>            <span class="n">ticker</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span>
</span><span id="portfolio-523"><a href="#portfolio-523"><span class="linenos">523</span></a>            <span class="n">buydate</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;buydate&#39;</span><span class="p">])</span>
</span><span id="portfolio-524"><a href="#portfolio-524"><span class="linenos">524</span></a>            <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">])</span>
</span><span id="portfolio-525"><a href="#portfolio-525"><span class="linenos">525</span></a>            <span class="n">portname</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;portname&#39;</span><span class="p">]</span>
</span><span id="portfolio-526"><a href="#portfolio-526"><span class="linenos">526</span></a>            <span class="n">initvalue</span> <span class="o">=</span> <span class="n">stock_init_val</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">buydate</span><span class="p">)</span>
</span><span id="portfolio-527"><a href="#portfolio-527"><span class="linenos">527</span></a>            <span class="n">portfadd</span> <span class="o">=</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">portfolioid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span>
</span><span id="portfolio-528"><a href="#portfolio-528"><span class="linenos">528</span></a>                                                 <span class="n">stockid</span><span class="o">=</span><span class="n">tickerexist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="portfolio-529"><a href="#portfolio-529"><span class="linenos">529</span></a>                                                 <span class="n">buydate</span><span class="o">=</span><span class="n">buydate</span><span class="p">,</span>
</span><span id="portfolio-530"><a href="#portfolio-530"><span class="linenos">530</span></a>                                                 <span class="n">quantity</span><span class="o">=</span><span class="n">quantity</span><span class="p">,</span>
</span><span id="portfolio-531"><a href="#portfolio-531"><span class="linenos">531</span></a>                                                 <span class="n">initvalue</span><span class="o">=</span><span class="n">initvalue</span><span class="p">,</span>
</span><span id="portfolio-532"><a href="#portfolio-532"><span class="linenos">532</span></a>                                                 <span class="n">name</span><span class="o">=</span><span class="n">portname</span><span class="p">)</span>
</span><span id="portfolio-533"><a href="#portfolio-533"><span class="linenos">533</span></a>            <span class="n">alcsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">portfadd</span><span class="p">)</span>
</span><span id="portfolio-534"><a href="#portfolio-534"><span class="linenos">534</span></a>            <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="portfolio-535"><a href="#portfolio-535"><span class="linenos">535</span></a>            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/portfolio&quot;</span><span class="p">)</span>
</span><span id="portfolio-536"><a href="#portfolio-536"><span class="linenos">536</span></a>
</span><span id="portfolio-537"><a href="#portfolio-537"><span class="linenos">537</span></a>        <span class="c1"># Returns active portfolio from session data</span>
</span><span id="portfolio-538"><a href="#portfolio-538"><span class="linenos">538</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">):</span>
</span><span id="portfolio-539"><a href="#portfolio-539"><span class="linenos">539</span></a>          <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="portfolio-540"><a href="#portfolio-540"><span class="linenos">540</span></a>          <span class="n">curr_val</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="portfolio-541"><a href="#portfolio-541"><span class="linenos">541</span></a>          <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">existsportfolio</span><span class="p">:</span>
</span><span id="portfolio-542"><a href="#portfolio-542"><span class="linenos">542</span></a>              <span class="n">stockdata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="portfolio-543"><a href="#portfolio-543"><span class="linenos">543</span></a>              <span class="n">portname</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">stockid</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">stockid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">activeportfolio</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="portfolio-544"><a href="#portfolio-544"><span class="linenos">544</span></a>              <span class="n">result</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">stockid</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">stockid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="portfolio-545"><a href="#portfolio-545"><span class="linenos">545</span></a>              <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;stockid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">stockid</span>
</span><span id="portfolio-546"><a href="#portfolio-546"><span class="linenos">546</span></a>              <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;stockname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="portfolio-547"><a href="#portfolio-547"><span class="linenos">547</span></a>              <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;buydate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">buydate</span>
</span><span id="portfolio-548"><a href="#portfolio-548"><span class="linenos">548</span></a>              <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">quantity</span>
</span><span id="portfolio-549"><a href="#portfolio-549"><span class="linenos">549</span></a>              <span class="n">stockdata</span><span class="p">[</span><span class="s1">&#39;initvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">initvalue</span>
</span><span id="portfolio-550"><a href="#portfolio-550"><span class="linenos">550</span></a>              <span class="n">curr_val</span> <span class="o">+=</span> <span class="n">stock_curr_val</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
</span><span id="portfolio-551"><a href="#portfolio-551"><span class="linenos">551</span></a>              <span class="nb">print</span><span class="p">(</span><span class="n">curr_val</span><span class="p">)</span>
</span><span id="portfolio-552"><a href="#portfolio-552"><span class="linenos">552</span></a>
</span><span id="portfolio-553"><a href="#portfolio-553"><span class="linenos">553</span></a>              <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stockdata</span><span class="p">)</span>
</span><span id="portfolio-554"><a href="#portfolio-554"><span class="linenos">554</span></a>          
</span><span id="portfolio-555"><a href="#portfolio-555"><span class="linenos">555</span></a>          <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;portfolio.html&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
</span><span id="portfolio-556"><a href="#portfolio-556"><span class="linenos">556</span></a>                                                    <span class="n">curr_val</span><span class="o">=</span><span class="n">curr_val</span><span class="p">,</span>
</span><span id="portfolio-557"><a href="#portfolio-557"><span class="linenos">557</span></a>                                                    <span class="n">activeportfolio</span><span class="o">=</span><span class="n">activeportfolio</span><span class="p">,</span>
</span><span id="portfolio-558"><a href="#portfolio-558"><span class="linenos">558</span></a>                                                    <span class="n">portfolionames</span><span class="o">=</span><span class="n">portfolionames</span><span class="p">)</span>
</span><span id="portfolio-559"><a href="#portfolio-559"><span class="linenos">559</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="portfolio-560"><a href="#portfolio-560"><span class="linenos">560</span></a>        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">)</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Portfolio endpoint
Handles interactions with a user's portfolio
Determines whether the request is a POST or GET request
and makes changes based on form data.
Allows naming of portfolios.</p>
</div>


                </section>
                <section id="watchlist">
                            <div class="attr function"><a class="headerlink" href="#watchlist">#&nbsp;&nbsp</a>

                <div class="decorator">@app.route(&#39;/watchlist&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])</div>

            <span class="def">def</span>
            <span class="name">watchlist</span><span class="signature">()</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="watchlist-563"><a href="#watchlist-563"><span class="linenos">563</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/watchlist&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span><span id="watchlist-564"><a href="#watchlist-564"><span class="linenos">564</span></a><span class="k">def</span> <span class="nf">watchlist</span><span class="p">():</span>
</span><span id="watchlist-565"><a href="#watchlist-565"><span class="linenos">565</span></a>
</span><span id="watchlist-566"><a href="#watchlist-566"><span class="linenos">566</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="watchlist-567"><a href="#watchlist-567"><span class="linenos">567</span></a><span class="sd">    Watchlist endpoint.</span>
</span><span id="watchlist-568"><a href="#watchlist-568"><span class="linenos">568</span></a><span class="sd">    This endpoint functions similar to the portfolio endpoint.</span>
</span><span id="watchlist-569"><a href="#watchlist-569"><span class="linenos">569</span></a><span class="sd">    It handles the names of watchlists and adding/removing </span>
</span><span id="watchlist-570"><a href="#watchlist-570"><span class="linenos">570</span></a><span class="sd">    them for users.</span>
</span><span id="watchlist-571"><a href="#watchlist-571"><span class="linenos">571</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="watchlist-572"><a href="#watchlist-572"><span class="linenos">572</span></a>
</span><span id="watchlist-573"><a href="#watchlist-573"><span class="linenos">573</span></a>    <span class="n">users</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="watchlist-574"><a href="#watchlist-574"><span class="linenos">574</span></a>    <span class="n">watchlists</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;watchlists&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="watchlist-575"><a href="#watchlist-575"><span class="linenos">575</span></a>    <span class="n">userstocks</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;userstocks&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="watchlist-576"><a href="#watchlist-576"><span class="linenos">576</span></a>    <span class="n">stocks</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;stocks&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="watchlist-577"><a href="#watchlist-577"><span class="linenos">577</span></a>
</span><span id="watchlist-578"><a href="#watchlist-578"><span class="linenos">578</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="p">):</span>
</span><span id="watchlist-579"><a href="#watchlist-579"><span class="linenos">579</span></a>        <span class="n">userinfo</span> <span class="o">=</span> <span class="n">session_info</span><span class="p">()</span>
</span><span id="watchlist-580"><a href="#watchlist-580"><span class="linenos">580</span></a>        <span class="n">uid</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;sub&#39;</span><span class="p">]</span>
</span><span id="watchlist-581"><a href="#watchlist-581"><span class="linenos">581</span></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="watchlist-582"><a href="#watchlist-582"><span class="linenos">582</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">users</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">uid</span> <span class="o">=</span> <span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="watchlist-583"><a href="#watchlist-583"><span class="linenos">583</span></a>        <span class="n">uid</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="watchlist-584"><a href="#watchlist-584"><span class="linenos">584</span></a>
</span><span id="watchlist-585"><a href="#watchlist-585"><span class="linenos">585</span></a>
</span><span id="watchlist-586"><a href="#watchlist-586"><span class="linenos">586</span></a>        <span class="n">existswatch</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">watchlists</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">wid</span> <span class="o">=</span> <span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="watchlist-587"><a href="#watchlist-587"><span class="linenos">587</span></a>
</span><span id="watchlist-588"><a href="#watchlist-588"><span class="linenos">588</span></a>        <span class="c1"># Keeping track of watchlists for users</span>
</span><span id="watchlist-589"><a href="#watchlist-589"><span class="linenos">589</span></a>        <span class="c1"># sets active watchlist as first index</span>
</span><span id="watchlist-590"><a href="#watchlist-590"><span class="linenos">590</span></a>        <span class="n">watchlistnames</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="watchlist-591"><a href="#watchlist-591"><span class="linenos">591</span></a>        <span class="k">for</span> <span class="n">row</span>  <span class="ow">in</span> <span class="n">existswatch</span><span class="p">:</span>
</span><span id="watchlist-592"><a href="#watchlist-592"><span class="linenos">592</span></a>            <span class="n">watchlistnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="watchlist-593"><a href="#watchlist-593"><span class="linenos">593</span></a>
</span><span id="watchlist-594"><a href="#watchlist-594"><span class="linenos">594</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="watchlist-595"><a href="#watchlist-595"><span class="linenos">595</span></a>            <span class="n">activewatchlist</span> <span class="o">=</span> <span class="n">watchlistnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="watchlist-596"><a href="#watchlist-596"><span class="linenos">596</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="watchlist-597"><a href="#watchlist-597"><span class="linenos">597</span></a>            <span class="n">activewatchlist</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="watchlist-598"><a href="#watchlist-598"><span class="linenos">598</span></a>
</span><span id="watchlist-599"><a href="#watchlist-599"><span class="linenos">599</span></a>
</span><span id="watchlist-600"><a href="#watchlist-600"><span class="linenos">600</span></a>        <span class="c1"># this is used when the watchlist is being retrieved</span>
</span><span id="watchlist-601"><a href="#watchlist-601"><span class="linenos">601</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">):</span>
</span><span id="watchlist-602"><a href="#watchlist-602"><span class="linenos">602</span></a>
</span><span id="watchlist-603"><a href="#watchlist-603"><span class="linenos">603</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="watchlist-604"><a href="#watchlist-604"><span class="linenos">604</span></a>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">existswatch</span><span class="p">:</span>
</span><span id="watchlist-605"><a href="#watchlist-605"><span class="linenos">605</span></a>                <span class="n">watchlistdata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="watchlist-606"><a href="#watchlist-606"><span class="linenos">606</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="watchlist-607"><a href="#watchlist-607"><span class="linenos">607</span></a>                    <span class="n">result</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">watchlists</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">stockid</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">stockid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">activewatchlist</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="watchlist-608"><a href="#watchlist-608"><span class="linenos">608</span></a>                    <span class="n">stockname</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">stockid</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">stockid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="watchlist-609"><a href="#watchlist-609"><span class="linenos">609</span></a>                    <span class="n">watchlistdata</span><span class="p">[</span><span class="s1">&#39;stockid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stockid</span>
</span><span id="watchlist-610"><a href="#watchlist-610"><span class="linenos">610</span></a>                    <span class="n">watchlistdata</span><span class="p">[</span><span class="s1">&#39;stockname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stockname</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="watchlist-611"><a href="#watchlist-611"><span class="linenos">611</span></a>                    <span class="n">stockeod</span> <span class="o">=</span> <span class="n">stockAPI</span><span class="p">(</span><span class="n">stockname</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="watchlist-612"><a href="#watchlist-612"><span class="linenos">612</span></a>                    <span class="n">watchlistdata</span><span class="p">[</span><span class="s1">&#39;currprice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stockeod</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
</span><span id="watchlist-613"><a href="#watchlist-613"><span class="linenos">613</span></a>                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">watchlistdata</span><span class="p">)</span>
</span><span id="watchlist-614"><a href="#watchlist-614"><span class="linenos">614</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="watchlist-615"><a href="#watchlist-615"><span class="linenos">615</span></a>                    <span class="k">continue</span>
</span><span id="watchlist-616"><a href="#watchlist-616"><span class="linenos">616</span></a>
</span><span id="watchlist-617"><a href="#watchlist-617"><span class="linenos">617</span></a>
</span><span id="watchlist-618"><a href="#watchlist-618"><span class="linenos">618</span></a>            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;WatchList.html&quot;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
</span><span id="watchlist-619"><a href="#watchlist-619"><span class="linenos">619</span></a>                                                    <span class="n">watchlistnames</span><span class="o">=</span><span class="n">watchlistnames</span><span class="p">)</span>
</span><span id="watchlist-620"><a href="#watchlist-620"><span class="linenos">620</span></a>
</span><span id="watchlist-621"><a href="#watchlist-621"><span class="linenos">621</span></a>        <span class="c1"># this is used when a stock is being added to the watchlist</span>
</span><span id="watchlist-622"><a href="#watchlist-622"><span class="linenos">622</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">):</span>
</span><span id="watchlist-623"><a href="#watchlist-623"><span class="linenos">623</span></a>
</span><span id="watchlist-624"><a href="#watchlist-624"><span class="linenos">624</span></a>            <span class="n">ticker</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]</span>
</span><span id="watchlist-625"><a href="#watchlist-625"><span class="linenos">625</span></a>            <span class="n">status</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;changelist&#39;</span><span class="p">]</span>
</span><span id="watchlist-626"><a href="#watchlist-626"><span class="linenos">626</span></a>
</span><span id="watchlist-627"><a href="#watchlist-627"><span class="linenos">627</span></a>            <span class="n">tickerexist</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="watchlist-628"><a href="#watchlist-628"><span class="linenos">628</span></a>            <span class="n">stockidexist</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">stockid</span> <span class="o">=</span> <span class="n">ticker</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="watchlist-629"><a href="#watchlist-629"><span class="linenos">629</span></a>
</span><span id="watchlist-630"><a href="#watchlist-630"><span class="linenos">630</span></a>            <span class="c1"># Sets the active watchlist to the ticker value</span>
</span><span id="watchlist-631"><a href="#watchlist-631"><span class="linenos">631</span></a>            <span class="c1"># Uses this to find the new active watchlist.</span>
</span><span id="watchlist-632"><a href="#watchlist-632"><span class="linenos">632</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Change Watchlist&quot;</span><span class="p">):</span>
</span><span id="watchlist-633"><a href="#watchlist-633"><span class="linenos">633</span></a>                <span class="n">activewatchlist</span> <span class="o">=</span> <span class="n">ticker</span>
</span><span id="watchlist-634"><a href="#watchlist-634"><span class="linenos">634</span></a>                <span class="n">getname</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">watchlists</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">wid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span>
</span><span id="watchlist-635"><a href="#watchlist-635"><span class="linenos">635</span></a>                                                                  <span class="n">name</span><span class="o">=</span><span class="n">ticker</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="watchlist-636"><a href="#watchlist-636"><span class="linenos">636</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="watchlist-637"><a href="#watchlist-637"><span class="linenos">637</span></a>                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">getname</span><span class="p">:</span>
</span><span id="watchlist-638"><a href="#watchlist-638"><span class="linenos">638</span></a>                    <span class="n">watchlistdata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="watchlist-639"><a href="#watchlist-639"><span class="linenos">639</span></a>                    <span class="n">result</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">watchlists</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">stockid</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">stockid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">activewatchlist</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="watchlist-640"><a href="#watchlist-640"><span class="linenos">640</span></a>                    <span class="n">stockname</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">stocks</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">stockid</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">stockid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="watchlist-641"><a href="#watchlist-641"><span class="linenos">641</span></a>                    <span class="n">watchlistdata</span><span class="p">[</span><span class="s1">&#39;stockid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">stockid</span>
</span><span id="watchlist-642"><a href="#watchlist-642"><span class="linenos">642</span></a>                    <span class="n">watchlistdata</span><span class="p">[</span><span class="s1">&#39;stockname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stockname</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="watchlist-643"><a href="#watchlist-643"><span class="linenos">643</span></a>                    <span class="n">stockeod</span> <span class="o">=</span> <span class="n">stockAPI</span><span class="p">(</span><span class="n">stockname</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="watchlist-644"><a href="#watchlist-644"><span class="linenos">644</span></a>                    <span class="n">watchlistdata</span><span class="p">[</span><span class="s1">&#39;currprice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stockeod</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
</span><span id="watchlist-645"><a href="#watchlist-645"><span class="linenos">645</span></a>                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">watchlistdata</span><span class="p">)</span>
</span><span id="watchlist-646"><a href="#watchlist-646"><span class="linenos">646</span></a>                <span class="c1">#return render_template(&quot;portfolio.html&quot;)</span>
</span><span id="watchlist-647"><a href="#watchlist-647"><span class="linenos">647</span></a>                <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;WatchList.html&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
</span><span id="watchlist-648"><a href="#watchlist-648"><span class="linenos">648</span></a>                                                          <span class="n">watchlistnames</span><span class="o">=</span><span class="n">watchlistnames</span><span class="p">,</span>
</span><span id="watchlist-649"><a href="#watchlist-649"><span class="linenos">649</span></a>                                                          <span class="n">activewatchlist</span><span class="o">=</span><span class="n">activewatchlist</span><span class="p">)</span>
</span><span id="watchlist-650"><a href="#watchlist-650"><span class="linenos">650</span></a>
</span><span id="watchlist-651"><a href="#watchlist-651"><span class="linenos">651</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Remove Watchlist&quot;</span><span class="p">):</span>
</span><span id="watchlist-652"><a href="#watchlist-652"><span class="linenos">652</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="watchlist-653"><a href="#watchlist-653"><span class="linenos">653</span></a>                    <span class="n">portfremove</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">watchlists</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">wid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">stockid</span><span class="o">=</span><span class="n">tickerexist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span id="watchlist-654"><a href="#watchlist-654"><span class="linenos">654</span></a>                    <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="watchlist-655"><a href="#watchlist-655"><span class="linenos">655</span></a>                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/watchlist&quot;</span><span class="p">)</span>
</span><span id="watchlist-656"><a href="#watchlist-656"><span class="linenos">656</span></a>                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
</span><span id="watchlist-657"><a href="#watchlist-657"><span class="linenos">657</span></a>                    <span class="n">portfremove</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">watchlists</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">wid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">stockid</span><span class="o">=</span><span class="n">stockidexist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span id="watchlist-658"><a href="#watchlist-658"><span class="linenos">658</span></a>                    <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="watchlist-659"><a href="#watchlist-659"><span class="linenos">659</span></a>                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/watchlist&quot;</span><span class="p">)</span>
</span><span id="watchlist-660"><a href="#watchlist-660"><span class="linenos">660</span></a>
</span><span id="watchlist-661"><a href="#watchlist-661"><span class="linenos">661</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Add Watchlist&quot;</span><span class="p">):</span>
</span><span id="watchlist-662"><a href="#watchlist-662"><span class="linenos">662</span></a>                <span class="n">watchname</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;watchname&#39;</span><span class="p">]</span>
</span><span id="watchlist-663"><a href="#watchlist-663"><span class="linenos">663</span></a>                <span class="n">watchlistinsert</span> <span class="o">=</span> <span class="n">watchlists</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">uid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span>
</span><span id="watchlist-664"><a href="#watchlist-664"><span class="linenos">664</span></a>                                                   <span class="n">wid</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span>
</span><span id="watchlist-665"><a href="#watchlist-665"><span class="linenos">665</span></a>                                                   <span class="n">stockid</span><span class="o">=</span><span class="n">tickerexist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="watchlist-666"><a href="#watchlist-666"><span class="linenos">666</span></a>                                                   <span class="n">name</span><span class="o">=</span><span class="n">watchname</span><span class="p">)</span>
</span><span id="watchlist-667"><a href="#watchlist-667"><span class="linenos">667</span></a>                <span class="n">alcsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">watchlistinsert</span><span class="p">)</span>
</span><span id="watchlist-668"><a href="#watchlist-668"><span class="linenos">668</span></a>                <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="watchlist-669"><a href="#watchlist-669"><span class="linenos">669</span></a>                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/watchlist&quot;</span><span class="p">)</span>
</span><span id="watchlist-670"><a href="#watchlist-670"><span class="linenos">670</span></a>
</span><span id="watchlist-671"><a href="#watchlist-671"><span class="linenos">671</span></a>            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;WatchList.html&quot;</span><span class="p">,</span><span class="n">tickerexist</span><span class="o">=</span><span class="n">tickerexist</span><span class="p">)</span>
</span><span id="watchlist-672"><a href="#watchlist-672"><span class="linenos">672</span></a>
</span><span id="watchlist-673"><a href="#watchlist-673"><span class="linenos">673</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="watchlist-674"><a href="#watchlist-674"><span class="linenos">674</span></a>        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">)</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Watchlist endpoint.
This endpoint functions similar to the portfolio endpoint.
It handles the names of watchlists and adding/removing 
them for users.</p>
</div>


                </section>
                <section id="snapshot">
                            <div class="attr function"><a class="headerlink" href="#snapshot">#&nbsp;&nbsp</a>

                <div class="decorator">@app.route(&#39;/snapshot&#39;, methods=[&#39;POST&#39;, &#39;GET&#39;])</div>

            <span class="def">def</span>
            <span class="name">snapshot</span><span class="signature">()</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="snapshot-677"><a href="#snapshot-677"><span class="linenos">677</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/snapshot&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">])</span>
</span><span id="snapshot-678"><a href="#snapshot-678"><span class="linenos">678</span></a><span class="k">def</span> <span class="nf">snapshot</span><span class="p">():</span>
</span><span id="snapshot-679"><a href="#snapshot-679"><span class="linenos">679</span></a>
</span><span id="snapshot-680"><a href="#snapshot-680"><span class="linenos">680</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="snapshot-681"><a href="#snapshot-681"><span class="linenos">681</span></a><span class="sd">    Andrew, Ryan</span>
</span><span id="snapshot-682"><a href="#snapshot-682"><span class="linenos">682</span></a><span class="sd">    When this endpoint is hit, an html file is returned that contains a mini snapshot of the current</span>
</span><span id="snapshot-683"><a href="#snapshot-683"><span class="linenos">683</span></a><span class="sd">    user&#39;s profile. It contains the profile&#39;s image, the user&#39;s total portfolio return percentage up/down,</span>
</span><span id="snapshot-684"><a href="#snapshot-684"><span class="linenos">684</span></a><span class="sd">    the user&#39;s best performing stock, and what percentage that stock is up/down.</span>
</span><span id="snapshot-685"><a href="#snapshot-685"><span class="linenos">685</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="snapshot-686"><a href="#snapshot-686"><span class="linenos">686</span></a>    
</span><span id="snapshot-687"><a href="#snapshot-687"><span class="linenos">687</span></a>    <span class="c1"># These are the 3 tables the sqlalchemy queries will need to use</span>
</span><span id="snapshot-688"><a href="#snapshot-688"><span class="linenos">688</span></a>    <span class="n">portfolios</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;portfolios&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="snapshot-689"><a href="#snapshot-689"><span class="linenos">689</span></a>    <span class="n">users</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="snapshot-690"><a href="#snapshot-690"><span class="linenos">690</span></a>    <span class="n">stocks</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;stocks&#39;</span><span class="p">,</span> <span class="n">metadata_obj</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span id="snapshot-691"><a href="#snapshot-691"><span class="linenos">691</span></a>
</span><span id="snapshot-692"><a href="#snapshot-692"><span class="linenos">692</span></a>    <span class="c1"># check to make sure a session is active</span>
</span><span id="snapshot-693"><a href="#snapshot-693"><span class="linenos">693</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="p">):</span>
</span><span id="snapshot-694"><a href="#snapshot-694"><span class="linenos">694</span></a>
</span><span id="snapshot-695"><a href="#snapshot-695"><span class="linenos">695</span></a>        <span class="c1"># get user id from session info in sqlalchemy query</span>
</span><span id="snapshot-696"><a href="#snapshot-696"><span class="linenos">696</span></a>        <span class="n">sessioninfo</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
</span><span id="snapshot-697"><a href="#snapshot-697"><span class="linenos">697</span></a>        <span class="n">pretty</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sessioninfo</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span><span id="snapshot-698"><a href="#snapshot-698"><span class="linenos">698</span></a>        <span class="n">userinfo</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pretty</span><span class="p">)</span>
</span><span id="snapshot-699"><a href="#snapshot-699"><span class="linenos">699</span></a>        <span class="n">uid</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;sub&#39;</span><span class="p">]</span>
</span><span id="snapshot-700"><a href="#snapshot-700"><span class="linenos">700</span></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="snapshot-701"><a href="#snapshot-701"><span class="linenos">701</span></a>        <span class="n">picture</span> <span class="o">=</span> <span class="n">userinfo</span><span class="p">[</span><span class="s1">&#39;userinfo&#39;</span><span class="p">][</span><span class="s1">&#39;picture&#39;</span><span class="p">]</span>
</span><span id="snapshot-702"><a href="#snapshot-702"><span class="linenos">702</span></a>
</span><span id="snapshot-703"><a href="#snapshot-703"><span class="linenos">703</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">users</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">uid</span> <span class="o">=</span> <span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="snapshot-704"><a href="#snapshot-704"><span class="linenos">704</span></a>        <span class="n">uid</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="snapshot-705"><a href="#snapshot-705"><span class="linenos">705</span></a>
</span><span id="snapshot-706"><a href="#snapshot-706"><span class="linenos">706</span></a>
</span><span id="snapshot-707"><a href="#snapshot-707"><span class="linenos">707</span></a>        <span class="c1"># This query gets the primary key, username, and the total amount invested for each user in the database</span>
</span><span id="snapshot-708"><a href="#snapshot-708"><span class="linenos">708</span></a>        <span class="n">sqlInvested</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">portfolioid</span><span class="p">,</span> <span class="n">users</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">initvalue</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;total_invested&#39;</span><span class="p">)</span>
</span><span id="snapshot-709"><a href="#snapshot-709"><span class="linenos">709</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">users</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">uid</span> <span class="o">==</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">portfolioid</span>
</span><span id="snapshot-710"><a href="#snapshot-710"><span class="linenos">710</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">portfolioid</span>
</span><span id="snapshot-711"><a href="#snapshot-711"><span class="linenos">711</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="snapshot-712"><a href="#snapshot-712"><span class="linenos">712</span></a>
</span><span id="snapshot-713"><a href="#snapshot-713"><span class="linenos">713</span></a>        <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="snapshot-714"><a href="#snapshot-714"><span class="linenos">714</span></a>
</span><span id="snapshot-715"><a href="#snapshot-715"><span class="linenos">715</span></a>        <span class="c1"># These are all of the lists where data will be stored</span>
</span><span id="snapshot-716"><a href="#snapshot-716"><span class="linenos">716</span></a>        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Array to hold the users from the database</span>
</span><span id="snapshot-717"><a href="#snapshot-717"><span class="linenos">717</span></a>        <span class="n">invested</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Array to hold total amount invested by each user</span>
</span><span id="snapshot-718"><a href="#snapshot-718"><span class="linenos">718</span></a>        <span class="n">current_amounts</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Array to hold current amount user&#39;s stocks are worth</span>
</span><span id="snapshot-719"><a href="#snapshot-719"><span class="linenos">719</span></a>        <span class="n">percentages</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds percentage for each user up/down</span>
</span><span id="snapshot-720"><a href="#snapshot-720"><span class="linenos">720</span></a>        <span class="n">usernames</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds usernames</span>
</span><span id="snapshot-721"><a href="#snapshot-721"><span class="linenos">721</span></a>        <span class="n">tickers</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds a list of tickers for each user</span>
</span><span id="snapshot-722"><a href="#snapshot-722"><span class="linenos">722</span></a>        <span class="n">userStocks</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds the current user&#39;s stocks</span>
</span><span id="snapshot-723"><a href="#snapshot-723"><span class="linenos">723</span></a>        <span class="n">currentValues</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds init values for each user stock</span>
</span><span id="snapshot-724"><a href="#snapshot-724"><span class="linenos">724</span></a>        <span class="n">differences</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds difference in init values for each stock</span>
</span><span id="snapshot-725"><a href="#snapshot-725"><span class="linenos">725</span></a>        <span class="n">previousValues</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Holds previous values for each stock</span>
</span><span id="snapshot-726"><a href="#snapshot-726"><span class="linenos">726</span></a>
</span><span id="snapshot-727"><a href="#snapshot-727"><span class="linenos">727</span></a>        <span class="c1"># Saves the returned data in the arrays</span>
</span><span id="snapshot-728"><a href="#snapshot-728"><span class="linenos">728</span></a>        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">sqlInvested</span><span class="p">:</span>
</span><span id="snapshot-729"><a href="#snapshot-729"><span class="linenos">729</span></a>            <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">portfolioid</span><span class="p">)</span>
</span><span id="snapshot-730"><a href="#snapshot-730"><span class="linenos">730</span></a>            <span class="n">usernames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="snapshot-731"><a href="#snapshot-731"><span class="linenos">731</span></a>            <span class="n">invested</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">total_invested</span><span class="p">)</span>
</span><span id="snapshot-732"><a href="#snapshot-732"><span class="linenos">732</span></a>
</span><span id="snapshot-733"><a href="#snapshot-733"><span class="linenos">733</span></a>        <span class="c1"># This query gets the primary key for who bought each stock, and then how much of the stock was bought.</span>
</span><span id="snapshot-734"><a href="#snapshot-734"><span class="linenos">734</span></a>        <span class="c1"># It also gets the ticker, so we can use it to find the current amount of the stock now.</span>
</span><span id="snapshot-735"><a href="#snapshot-735"><span class="linenos">735</span></a>        <span class="n">getTickers</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">portfolioid</span><span class="p">,</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="n">stocks</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">ticker</span>
</span><span id="snapshot-736"><a href="#snapshot-736"><span class="linenos">736</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stocks</span><span class="p">,</span> <span class="n">stocks</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">stockid</span> <span class="o">==</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">stockid</span>
</span><span id="snapshot-737"><a href="#snapshot-737"><span class="linenos">737</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="snapshot-738"><a href="#snapshot-738"><span class="linenos">738</span></a>
</span><span id="snapshot-739"><a href="#snapshot-739"><span class="linenos">739</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">getTickers</span><span class="p">)</span>
</span><span id="snapshot-740"><a href="#snapshot-740"><span class="linenos">740</span></a>
</span><span id="snapshot-741"><a href="#snapshot-741"><span class="linenos">741</span></a>        <span class="c1"># Goes through all of the tickers that we just got from the previous query.</span>
</span><span id="snapshot-742"><a href="#snapshot-742"><span class="linenos">742</span></a>        <span class="c1"># Goes through each user stored in the users list earlier.</span>
</span><span id="snapshot-743"><a href="#snapshot-743"><span class="linenos">743</span></a>        <span class="c1"># If the primary key matches the user we are current searching for, we hit the api</span>
</span><span id="snapshot-744"><a href="#snapshot-744"><span class="linenos">744</span></a>        <span class="c1"># to find the current price of the stock, and multiply it by the original quantity.</span>
</span><span id="snapshot-745"><a href="#snapshot-745"><span class="linenos">745</span></a>        <span class="c1"># The total is then added onto the total variable, and at the end, the total</span>
</span><span id="snapshot-746"><a href="#snapshot-746"><span class="linenos">746</span></a>        <span class="c1"># is stored in the current_amounts list.</span>
</span><span id="snapshot-747"><a href="#snapshot-747"><span class="linenos">747</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)):</span>
</span><span id="snapshot-748"><a href="#snapshot-748"><span class="linenos">748</span></a>            <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="snapshot-749"><a href="#snapshot-749"><span class="linenos">749</span></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">getTickers</span><span class="p">:</span>
</span><span id="snapshot-750"><a href="#snapshot-750"><span class="linenos">750</span></a>                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">portfolioid</span> <span class="o">==</span> <span class="n">users</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="snapshot-751"><a href="#snapshot-751"><span class="linenos">751</span></a>                    <span class="n">api_reponse</span> <span class="o">=</span> <span class="n">stockAPI</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">ticker</span><span class="p">)</span>
</span><span id="snapshot-752"><a href="#snapshot-752"><span class="linenos">752</span></a>                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
</span><span id="snapshot-753"><a href="#snapshot-753"><span class="linenos">753</span></a>
</span><span id="snapshot-754"><a href="#snapshot-754"><span class="linenos">754</span></a>                    <span class="n">init_value</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="snapshot-755"><a href="#snapshot-755"><span class="linenos">755</span></a>                    <span class="n">init_value</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">api_reponse</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">)</span>
</span><span id="snapshot-756"><a href="#snapshot-756"><span class="linenos">756</span></a>
</span><span id="snapshot-757"><a href="#snapshot-757"><span class="linenos">757</span></a>                    <span class="n">total</span> <span class="o">+=</span> <span class="n">init_value</span>
</span><span id="snapshot-758"><a href="#snapshot-758"><span class="linenos">758</span></a>
</span><span id="snapshot-759"><a href="#snapshot-759"><span class="linenos">759</span></a>            <span class="n">current_amounts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
</span><span id="snapshot-760"><a href="#snapshot-760"><span class="linenos">760</span></a>
</span><span id="snapshot-761"><a href="#snapshot-761"><span class="linenos">761</span></a>        <span class="c1"># Takes the current amount of the stocks - the total cost of the stocks to begin with, and divides it by</span>
</span><span id="snapshot-762"><a href="#snapshot-762"><span class="linenos">762</span></a>        <span class="c1"># the total amount initially. Multiplying it by 100 then gives us the percentage up/down for each user</span>
</span><span id="snapshot-763"><a href="#snapshot-763"><span class="linenos">763</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)):</span>
</span><span id="snapshot-764"><a href="#snapshot-764"><span class="linenos">764</span></a>            <span class="n">percentages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">current_amounts</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">invested</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">invested</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="snapshot-765"><a href="#snapshot-765"><span class="linenos">765</span></a>
</span><span id="snapshot-766"><a href="#snapshot-766"><span class="linenos">766</span></a>        <span class="c1"># https://stackoverflow.com/questions/19931975/sort-multiple-lists-simultaneously</span>
</span><span id="snapshot-767"><a href="#snapshot-767"><span class="linenos">767</span></a>        <span class="c1"># Sort both lists in the same way</span>
</span><span id="snapshot-768"><a href="#snapshot-768"><span class="linenos">768</span></a>        <span class="n">percentages_sorted</span><span class="p">,</span> <span class="n">users_sorted</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">percentages</span><span class="p">,</span> <span class="n">users</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
</span><span id="snapshot-769"><a href="#snapshot-769"><span class="linenos">769</span></a>
</span><span id="snapshot-770"><a href="#snapshot-770"><span class="linenos">770</span></a>        <span class="c1"># Gets user&#39;s current position on the leaderboard</span>
</span><span id="snapshot-771"><a href="#snapshot-771"><span class="linenos">771</span></a>        <span class="c1"># Gets user&#39;s total portfolio return</span>
</span><span id="snapshot-772"><a href="#snapshot-772"><span class="linenos">772</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">users_sorted</span><span class="p">)):</span>
</span><span id="snapshot-773"><a href="#snapshot-773"><span class="linenos">773</span></a>            <span class="k">if</span> <span class="n">users_sorted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span><span class="p">:</span>
</span><span id="snapshot-774"><a href="#snapshot-774"><span class="linenos">774</span></a>                <span class="n">leaderboardPos</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="snapshot-775"><a href="#snapshot-775"><span class="linenos">775</span></a>                <span class="n">totalPortfolioReturn</span> <span class="o">=</span> <span class="n">percentages_sorted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="snapshot-776"><a href="#snapshot-776"><span class="linenos">776</span></a>
</span><span id="snapshot-777"><a href="#snapshot-777"><span class="linenos">777</span></a>
</span><span id="snapshot-778"><a href="#snapshot-778"><span class="linenos">778</span></a>        <span class="c1"># ----------------------------------------------------------------------</span>
</span><span id="snapshot-779"><a href="#snapshot-779"><span class="linenos">779</span></a>        <span class="c1"># This part is for finding best performing stock</span>
</span><span id="snapshot-780"><a href="#snapshot-780"><span class="linenos">780</span></a>        <span class="c1"># Query to get portfolio id, and stock info for all stocks in db</span>
</span><span id="snapshot-781"><a href="#snapshot-781"><span class="linenos">781</span></a>        <span class="n">sqlInvested</span> <span class="o">=</span> <span class="n">alcsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">portfolioid</span><span class="p">,</span> <span class="n">stocks</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="n">stocks</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">initvalue</span>
</span><span id="snapshot-782"><a href="#snapshot-782"><span class="linenos">782</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stocks</span><span class="p">,</span> <span class="n">stocks</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">stockid</span> <span class="o">==</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">stockid</span>
</span><span id="snapshot-783"><a href="#snapshot-783"><span class="linenos">783</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="snapshot-784"><a href="#snapshot-784"><span class="linenos">784</span></a>
</span><span id="snapshot-785"><a href="#snapshot-785"><span class="linenos">785</span></a>        <span class="n">alcsession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="snapshot-786"><a href="#snapshot-786"><span class="linenos">786</span></a>
</span><span id="snapshot-787"><a href="#snapshot-787"><span class="linenos">787</span></a>
</span><span id="snapshot-788"><a href="#snapshot-788"><span class="linenos">788</span></a>        <span class="c1"># Get current init_values for all stocks</span>
</span><span id="snapshot-789"><a href="#snapshot-789"><span class="linenos">789</span></a>        <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">sqlInvested</span><span class="p">:</span>
</span><span id="snapshot-790"><a href="#snapshot-790"><span class="linenos">790</span></a>            <span class="k">if</span> <span class="n">stock</span><span class="o">.</span><span class="n">portfolioid</span> <span class="o">==</span> <span class="n">uid</span><span class="p">:</span>
</span><span id="snapshot-791"><a href="#snapshot-791"><span class="linenos">791</span></a>                <span class="n">userStocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stock</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="snapshot-792"><a href="#snapshot-792"><span class="linenos">792</span></a>                <span class="n">previousValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stock</span><span class="o">.</span><span class="n">initvalue</span> <span class="o">/</span> <span class="n">stock</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
</span><span id="snapshot-793"><a href="#snapshot-793"><span class="linenos">793</span></a>                <span class="n">api_response</span> <span class="o">=</span> <span class="n">stockAPI</span><span class="p">(</span><span class="n">stock</span><span class="o">.</span><span class="n">ticker</span><span class="p">)</span>  <span class="c1"># Call api</span>
</span><span id="snapshot-794"><a href="#snapshot-794"><span class="linenos">794</span></a>                <span class="n">init_value</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="snapshot-795"><a href="#snapshot-795"><span class="linenos">795</span></a>                <span class="n">init_value</span> <span class="o">=</span> <span class="n">stock</span><span class="o">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="n">api_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">)</span>
</span><span id="snapshot-796"><a href="#snapshot-796"><span class="linenos">796</span></a>                <span class="n">currentValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">init_value</span><span class="p">)</span>
</span><span id="snapshot-797"><a href="#snapshot-797"><span class="linenos">797</span></a>
</span><span id="snapshot-798"><a href="#snapshot-798"><span class="linenos">798</span></a>
</span><span id="snapshot-799"><a href="#snapshot-799"><span class="linenos">799</span></a>        <span class="c1"># Find the largest difference between init values (then vs. now)</span>
</span><span id="snapshot-800"><a href="#snapshot-800"><span class="linenos">800</span></a>        <span class="c1"># We would then return the best performing stock, and how much percentage it is up</span>
</span><span id="snapshot-801"><a href="#snapshot-801"><span class="linenos">801</span></a>        <span class="n">percentage</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="snapshot-802"><a href="#snapshot-802"><span class="linenos">802</span></a>        <span class="n">bestStock</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="snapshot-803"><a href="#snapshot-803"><span class="linenos">803</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentValues</span><span class="p">)):</span>
</span><span id="snapshot-804"><a href="#snapshot-804"><span class="linenos">804</span></a>            <span class="n">differences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">currentValues</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">previousValues</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</span><span id="snapshot-805"><a href="#snapshot-805"><span class="linenos">805</span></a>
</span><span id="snapshot-806"><a href="#snapshot-806"><span class="linenos">806</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">differences</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">percentage</span><span class="p">):</span>
</span><span id="snapshot-807"><a href="#snapshot-807"><span class="linenos">807</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;differences done&quot;</span><span class="p">)</span>
</span><span id="snapshot-808"><a href="#snapshot-808"><span class="linenos">808</span></a>                <span class="n">bestStock</span> <span class="o">=</span> <span class="n">userStocks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="snapshot-809"><a href="#snapshot-809"><span class="linenos">809</span></a>                <span class="n">percentage</span> <span class="o">=</span> <span class="n">differences</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="snapshot-810"><a href="#snapshot-810"><span class="linenos">810</span></a>
</span><span id="snapshot-811"><a href="#snapshot-811"><span class="linenos">811</span></a>
</span><span id="snapshot-812"><a href="#snapshot-812"><span class="linenos">812</span></a>        <span class="c1"># Returns the downloadable HTML file</span>
</span><span id="snapshot-813"><a href="#snapshot-813"><span class="linenos">813</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;creating file&quot;</span><span class="p">)</span>
</span><span id="snapshot-814"><a href="#snapshot-814"><span class="linenos">814</span></a>        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;stats.html&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
</span><span id="snapshot-815"><a href="#snapshot-815"><span class="linenos">815</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;html&gt;</span>
</span><span id="snapshot-816"><a href="#snapshot-816"><span class="linenos">816</span></a><span class="s2">                    &lt;head&gt;</span>
</span><span id="snapshot-817"><a href="#snapshot-817"><span class="linenos">817</span></a><span class="s2">                    &lt;title&gt;Stats&lt;/title&gt;</span>
</span><span id="snapshot-818"><a href="#snapshot-818"><span class="linenos">818</span></a><span class="s2">                    &lt;/head&gt;</span>
</span><span id="snapshot-819"><a href="#snapshot-819"><span class="linenos">819</span></a><span class="s2">                    &lt;body&gt;</span>
</span><span id="snapshot-820"><a href="#snapshot-820"><span class="linenos">820</span></a>
</span><span id="snapshot-821"><a href="#snapshot-821"><span class="linenos">821</span></a><span class="s2">                    &lt;img src=</span><span class="si">{</span><span class="n">picture</span><span class="si">}</span><span class="s2">&gt;</span>
</span><span id="snapshot-822"><a href="#snapshot-822"><span class="linenos">822</span></a><span class="s2">                    &lt;p style=&quot;font-weight:bold&quot;&gt;Total Portfolio Return: </span><span class="si">{</span><span class="n">totalPortfolioReturn</span><span class="si">}</span><span class="s2">&lt;/p&gt;</span>
</span><span id="snapshot-823"><a href="#snapshot-823"><span class="linenos">823</span></a><span class="s2">                    &lt;p&gt;Leaderboard Position: </span><span class="si">{</span><span class="n">leaderboardPos</span><span class="si">}</span><span class="s2">&lt;/p&gt;</span>
</span><span id="snapshot-824"><a href="#snapshot-824"><span class="linenos">824</span></a><span class="s2">                    &lt;p&gt;Best Stock: </span><span class="si">{</span><span class="n">bestStock</span><span class="si">}</span><span class="s2">&lt;/p&gt;</span>
</span><span id="snapshot-825"><a href="#snapshot-825"><span class="linenos">825</span></a><span class="s2">                    &lt;p&gt;</span><span class="si">{</span><span class="n">bestStock</span><span class="si">}</span><span class="s2"> percentage: </span><span class="si">{</span><span class="n">percentage</span><span class="si">}</span><span class="s2">%&lt;/p&gt;</span>
</span><span id="snapshot-826"><a href="#snapshot-826"><span class="linenos">826</span></a>
</span><span id="snapshot-827"><a href="#snapshot-827"><span class="linenos">827</span></a><span class="s2">                    &lt;/body&gt;</span>
</span><span id="snapshot-828"><a href="#snapshot-828"><span class="linenos">828</span></a><span class="s2">                    &lt;/html&gt;</span>
</span><span id="snapshot-829"><a href="#snapshot-829"><span class="linenos">829</span></a><span class="s2">                    &quot;&quot;&quot;</span>
</span><span id="snapshot-830"><a href="#snapshot-830"><span class="linenos">830</span></a>        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="snapshot-831"><a href="#snapshot-831"><span class="linenos">831</span></a>        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="snapshot-832"><a href="#snapshot-832"><span class="linenos">832</span></a>
</span><span id="snapshot-833"><a href="#snapshot-833"><span class="linenos">833</span></a>        <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="s2">&quot;stats.html&quot;</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="snapshot-834"><a href="#snapshot-834"><span class="linenos">834</span></a>
</span><span id="snapshot-835"><a href="#snapshot-835"><span class="linenos">835</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="snapshot-836"><a href="#snapshot-836"><span class="linenos">836</span></a>        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">)</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Andrew, Ryan
When this endpoint is hit, an html file is returned that contains a mini snapshot of the current
user's profile. It contains the profile's image, the user's total portfolio return percentage up/down,
the user's best performing stock, and what percentage that stock is up/down.</p>
</div>


                </section>
                <section id="page_not_found">
                            <div class="attr function"><a class="headerlink" href="#page_not_found">#&nbsp;&nbsp</a>

                <div class="decorator">@app.errorhandler(500)</div>

            <span class="def">def</span>
            <span class="name">page_not_found</span><span class="signature">(e)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="page_not_found-838"><a href="#page_not_found-838"><span class="linenos">838</span></a><span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
</span><span id="page_not_found-839"><a href="#page_not_found-839"><span class="linenos">839</span></a><span class="k">def</span> <span class="nf">page_not_found</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
</span><span id="page_not_found-840"><a href="#page_not_found-840"><span class="linenos">840</span></a>
</span><span id="page_not_found-841"><a href="#page_not_found-841"><span class="linenos">841</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="page_not_found-842"><a href="#page_not_found-842"><span class="linenos">842</span></a><span class="sd">    Displays the 500.html error page, to actually handle errors</span>
</span><span id="page_not_found-843"><a href="#page_not_found-843"><span class="linenos">843</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="page_not_found-844"><a href="#page_not_found-844"><span class="linenos">844</span></a>    <span class="k">return</span><span class="p">(</span><span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;500.html&quot;</span><span class="p">))</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Displays the 500.html error page, to actually handle errors</p>
</div>


                </section>
    </main>
</body>
</html>